<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Game T√†i X·∫ø Giao H√†ng - ƒê√°p √°n ·ªü To√†</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #a5dff9; margin: 0; }
    .container { display: flex; margin-top: 16px; }
    .game-info { background: #fffbe8; border-radius: 15px; box-shadow: 0 2px 8px #9996; padding: 12px 18px; min-width: 216px; text-align: center; line-height: 1.5;}
    .score, .lives, .question-level { font-weight: bold; font-size: 18px; }
    .question-box { min-height: 54px; margin: 9px 0; border: 2px dashed #66c; border-radius: 7px; background: #f7f7fc; padding: 5px;}
    .question-answers { min-height: 29px;}
    .cell { border: 1px solid #b3d6ad; background: #eaffed; height: 36px; width: 36px; position: relative; display: flex; justify-content: center; align-items: center;}
    .grid { display: grid; grid-template-columns: repeat(12, 36px); grid-template-rows: repeat(12, 36px); background: #9fd8aa; border: 5px solid #427837; border-radius: 11px; box-shadow: 0 5px 16px #094d19ab; position: relative;}
    .driver { font-size: 1.4rem; z-index:2; }
    .pickup { font-size: 1.2rem; font-weight: bold; border-radius: 8px; background: #fffbab; border: 2px solid #f5e63f; width: 28px; height: 28px; display: flex;align-items:center;justify-content:center;}
    .dropoff { font-size: 1.2rem; font-weight: bold; border-radius: 8px; background: #eacfa5; border: 2px solid #8b5702; width: 28px; height: 28px; display: flex;align-items:center;justify-content:center;}
    .birthday { background: #ffe0ee; color: #f13b8f; border-radius: 8px; width: 28px; height: 28px; font-size: 1.2rem; display: flex;align-items:center;justify-content:center; border: 2px solid #e34290;}
    .inactive { background: #888; color: #fff; border-radius: 12px; width: 28px; height: 28px; font-size: 1rem; opacity: .7;display: flex;align-items:center;justify-content:center;}
    .answer-building { background: #f3e87e !important; border:2px solid #f1cd20 !important; cursor:pointer;}
    .chosen-wrong { background: #fcb4b4 !important; border:2px solid #b21d1d !important;}
    .obstacle {background: #bbb url('https://cdn-icons-png.flaticon.com/128/616/616433.png') center/24px 24px no-repeat; border-radius: 6px;}
    .msg { color: #1b2b3a; font-size: 17px; min-height: 27px;}
    .game-over, .game-win { background: #fffbe8; border: 2px solid #e01919; border-radius: 8px; padding: 18px; font-size: 2rem; font-weight: bold; color: #e01919; position: absolute; top: 45%; left: 50%; transform: translate(-50%,-50%); z-index: 9; min-width: 280px; text-align: center; box-shadow: 0 8px 24px #4445;}
    .game-win { color: #145a1b; border-color: #47c661;}
    .controller { display: flex; flex-direction: column; align-items: center; margin: 6px 0;}
    .ctrl-btns { display: flex; flex-direction: row; gap:20px;}
    .ctrl-up, .ctrl-down, .ctrl-left, .ctrl-right { width: 36px; height: 36px; text-align:center; font-size:24px; border-radius: 8px; background: #e4f6ff; cursor:pointer; border:1px solid #7ac5f5; margin:2px; user-select:none;}
    .ctrl-up:active, .ctrl-down:active, .ctrl-left:active, .ctrl-right:active {background:#b0ebfb;}
  </style>
</head>
<body>
  <div class="container">
    <div class="game-info">
      <div><b>T√†i X·∫ø: </b>Player 1</div>
      <div><span class="score">ƒêi·ªÉm: 0</span> | <span class="lives">Nh√† c√≤n: 10</span></div>
      <div class="question-level">ƒê·ªô kh√≥: 1</div>
      <hr>
      <div class="question-box"></div>
      <div class="question-answers"></div>
      <div class="msg"></div>
      <hr>
      <div class="controller">
        <div><b>Di chuy·ªÉn</b></div>
        <div>
          <button class="ctrl-up" title="L√™n">‚¨ÜÔ∏è</button>
        </div>
        <div class="ctrl-btns">
          <button class="ctrl-left" title="Tr√°i">‚¨ÖÔ∏è</button>
          <button class="ctrl-down" title="Xu·ªëng">‚¨áÔ∏è</button>
          <button class="ctrl-right" title="Ph·∫£i">‚û°Ô∏è</button>
        </div>
      </div>
    </div>
    <div style="position:relative;">
      <div id="gameGrid" class="grid"></div>
      <div id="endScene"></div>
    </div>
  </div>
<script>
const ROWS = 12, COLS = 12, TOTAL_STOP = 10;
// C√°c t√≤a nh√† c·ªë ƒë·ªãnh
const BUILDINGS = [
  {x: 1, y: 1, type:"pickup"},
  {x: 6, y: 2, type:"dropoff"},
  {x: 2, y: 7, type:"pickup"},
  {x: 9, y: 3, type:"dropoff"},
  {x: 6, y: 10, type:"pickup"},
  {x: 10, y: 8, type:"dropoff"},
  {x: 4, y: 5, type:"pickup"},
  {x: 8, y: 7, type:"dropoff"},
  {x: 2, y: 10, type:"pickup"},
  {x: 9, y: 9, type:"dropoff"}
];
// Ch∆∞·ªõng ng·∫°i v·∫≠t
const OBSTACLES = [
  {x:3, y:1},{x:4,y:1},{x:5,y:1},{x:7,y:3},{x:8,y:4},{x:2,y:3},{x:3,y:8},
  {x:0,y:11},{x:1,y:11},{x:2,y:11},{x:8,y:6}, {x:6,y:6}, {x:4,y:9},
  {x:5,y:7}, {x:1, y:8},{x:7,y:11},{x:7,y:10},{x:7,y:9},{x:7,y:8},{x:9,y:0},{x:8,y:0},{x:7,y:0}
];
// B·ªô c√¢u h·ªèi
let questions = [
  {question:'ƒê√¢u l√† qu·∫≠n trung t√¢m TP.HCM?',options:['Qu·∫≠n 1','Nh√† B√®','C·∫ßn Gi·ªù'],correct:'Qu·∫≠n 1',level:1},
  {question:'Ch·ª£ B·∫øn Th√†nh n·∫±m ·ªü qu·∫≠n n√†o?',options:['Qu·∫≠n 1', 'Qu·∫≠n 4', 'Qu·∫≠n 7'], correct:'Qu·∫≠n 1',level:1},
  {question:'C·∫ßu Ph√∫ M·ªπ n·ªëi Qu·∫≠n 2 v·ªõi qu·∫≠n n√†o?',options:['Qu·∫≠n 7', 'B√¨nh Th·∫°nh', 'G√≤ V·∫•p'],correct:'Qu·∫≠n 7',level:2},
  {question:'ƒê·ªãa ch·ªâ n√†o xa nh·∫•t kh·ªèi trung t√¢m?',options:['C·ªß Chi', 'B√¨nh Th·∫°nh', 'Qu·∫≠n 4'],correct:'C·ªß Chi',level:2},
  {question:'‚ÄúBitexco‚Äù cao bao nhi√™u t·∫ßng?',options:['68', '49', '72'],correct:'68',level:3},
  {question:'B·ªánh vi·ªán Ch·ª£ R·∫´y n·∫±m ·ªü ƒë√¢u?',options:['Qu·∫≠n 5', 'Qu·∫≠n 7', 'Qu·∫≠n 10'],correct:'Qu·∫≠n 5',level:3},
  {question:'ƒê∆∞·ªùng xa nh·∫•t trong 3 ƒë∆∞·ªùng?',options:['Nguy·ªÖn H·ªØu Th·ªç', 'Nguy·ªÖn Tr√£i', 'L√™ L·ª£i'],correct:'Nguy·ªÖn H·ªØu Th·ªç',level:4},
  {question:'Khu ƒë√¥ th·ªã s·∫ßm u·∫•t ph√≠a ƒê√¥ng S√†i G√≤n?',options:['Th·ªß Thi√™m', 'Ph√∫ M·ªπ H∆∞ng', 'Vƒ©nh L·ªôc'],correct:'Th·ªß Thi√™m',level:4},
  {question:'T√≤a nh√† Landmark 81 thu·ªôc qu·∫≠n n√†o?',options:['B√¨nh Th·∫°nh', 'Qu·∫≠n 1', 'Qu·∫≠n 3'],correct:'B√¨nh Th·∫°nh',level:5},
  {question:'B·∫øn xe mi·ªÅn T√¢y thu·ªôc qu·∫≠n/huy·ªán n√†o?',options:['B√¨nh T√¢n', 'Qu·∫≠n 8', 'B√¨nh Ch√°nh'],correct:'B√¨nh T√¢n',level:5}
];

let gridArr = [];
let score=0, difficulty = 1, currQuestion = null, currAnswers = [];
let currAnswerBuildings = [];
let inactiveBuildings = [];
let doneBuildingCount = 0;
let driverPos = { x: BUILDINGS[0].x, y: BUILDINGS[0].y };
let awaitingAnswer = false, lives = TOTAL_STOP, gameOver = false, gameWin = false;
let lastChosenCell = null;

function createGridArr() {
  gridArr = [];
  for (let y = 0; y < ROWS; y++) {
    let row = [];
    for (let x = 0; x < COLS; x++) {
      row.push({
        x, y,
        isPickup: false, isDropoff: false,
        isInactive: false, isBirthday: false,
        isObstacle: false,
        isAnswer: false,  // L√† to√† hi·ªÉn th·ªã ƒë√°p √°n?
        answerText: null,
        isDone: false
      });
    }
    gridArr.push(row);
  }
  BUILDINGS.forEach(pt => {
    if (pt.type == "pickup") gridArr[pt.y][pt.x].isPickup = true;
    if (pt.type == "dropoff") gridArr[pt.y][pt.x].isDropoff = true;
  });
  OBSTACLES.forEach(pt => { gridArr[pt.y][pt.x].isObstacle = true; });
}

function drawGrid() {
  let gridDiv = document.getElementById('gameGrid');
  gridDiv.innerHTML = '';
  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      let cell = gridArr[y][x];
      let html = '';
      let classes = "";
      // Ch∆∞·ªõng ng·∫°i
      if(cell.isObstacle) {
        classes += " obstacle";
      }
      // To√† ƒë√°p √°n
      else if (cell.isAnswer) {
        classes += " answer-building";
        html = `<div><span title="ƒê√°p √°n">${cell.answerText}</span></div>`;
        if(lastChosenCell && lastChosenCell.x === x && lastChosenCell.y === y && !cell.isDone && !cell.isInactive && !cell.isPickup && !cell.isDropoff)
            classes += " chosen-wrong";
      }
      // To√† nh√† disable
      else if (cell.isInactive) {
        html = `<div class="inactive" title="ƒê√£ v√¥ hi·ªáu ho√°">‚ùå</div>`;
      }
      // Birthday
      else if (cell.isBirthday) {
        html = `<div class="birthday" title="Sinh nh·∫≠t">üéÇ</div>`;
      }
      // Pickup/Dropoff
      else if (cell.isPickup) {
        html = `<div class="pickup" title="ƒêi·ªÉm nh·∫≠n h√†ng">üè¢</div>`;
      }
      else if (cell.isDropoff) {
        html = `<div class="dropoff" title="ƒêi·ªÉm giao h√†ng">üè¨</div>`;
      }
      // Driver
      if(driverPos.x === x && driverPos.y === y) {
        html = `<div class="driver" title="T√†i x·∫ø">üöö</div>`;
      }
      gridDiv.innerHTML += `<div class="cell${classes}">${html}</div>`;
    }
  }
}

function updateInfo() {
  document.querySelector('.score').innerText = `ƒêi·ªÉm: ${score}`;
  document.querySelector('.lives').innerText = `Nh√† c√≤n: ${TOTAL_STOP - inactiveBuildings.length}`;
  document.querySelector('.question-level').innerText = `ƒê·ªô kh√≥: ${difficulty}`;
}
function hideQuestion() {
  document.querySelector('.question-box').innerText = '';
  document.querySelector('.question-answers').innerHTML = '';
  document.querySelector('.msg').innerText = '';
}
function showMsg(t,msg) {
  document.querySelector('.msg').innerText = msg;
  if(t>0) setTimeout(()=>document.querySelector('.msg').innerText='',t);
}

function move(dx,dy) {
  if(gameOver || gameWin || awaitingAnswer) return;
  let nx = driverPos.x + dx, ny = driverPos.y + dy;
  if (nx<0 || nx>=COLS || ny<0 || ny>=ROWS) return;
  let cell = gridArr[ny][nx];
  if (cell.isObstacle) return;
  driverPos.x = nx; driverPos.y = ny;
  drawGrid();
  checkCell();
}
document.querySelector('.ctrl-up').onclick = ()=>move(0,-1);
document.querySelector('.ctrl-down').onclick = ()=>move(0,1);
document.querySelector('.ctrl-left').onclick = ()=>move(-1,0);
document.querySelector('.ctrl-right').onclick = ()=>move(1,0);
document.addEventListener('keydown',e=>{
  if(gameOver || gameWin || awaitingAnswer) return;
  if(e.key==='ArrowUp') move(0,-1);
  else if(e.key==='ArrowDown') move(0,1);
  else if(e.key==='ArrowLeft') move(-1,0);
  else if(e.key==='ArrowRight') move(1,0);
});

function checkCell() {
  let cell = gridArr[driverPos.y][driverPos.x];
  // N·∫øu ƒëang c√≥ 3 t√≤a ƒë√°p √°n
  if (cell.isAnswer && awaitingAnswer) {
    answerBuildingAction(cell);
    return;
  }
  // Th·∫Øng!
  if (cell.isBirthday) {
    setTimeout(()=>showEnd('game-win'),400);
    return;
  }
  // ƒê·∫øn t√≤a nh√†: pickup/dropoff (c√≤n active/ch∆∞a l√†m, ko ph·∫£i t√≤a ƒë√°p √°n)?
  if ((cell.isPickup || cell.isDropoff) && !cell.isInactive && !cell.isDone && !awaitingAnswer) {
    createAnswerBuildings(cell);
    awaitingAnswer = true;
    drawGrid();
    hideQuestion();
    showQuestionBox();
    return;
  }
  hideQuestion();
}

function shuffle(arr) {
  for(let i=arr.length-1;i>0;--i) {
    let j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  } return arr;
}
function randomOtherBuildings_exc(excl=[]) {
  // Tr·∫£ v·ªÅ danh s√°ch c√°c t√≤a h·ª£p l·ªá ƒë·ªÉ g√°n l√†m nh√† ƒë√°p √°n (ch∆∞a v√¥ hi·ªáu, ch∆∞a l√† birthday, ch∆∞a l√† c√πng ch·ªó t√†i x·∫ø, ch∆∞a t·ª´ng l√† to√† ƒë√°p √°n ƒëang ch·ªù)
  let excludeSet = excl.map(pt=>pt.x+','+pt.y);
  let eligible = [];
  for(let y=0; y<ROWS; y++)
    for(let x=0; x<COLS; x++) {
      let cell = gridArr[y][x];
      if(cell.isObstacle||cell.isInactive||cell.isBirthday||(driverPos.x===x&&driverPos.y===y)) continue;
      // Kh√¥ng d√πng hai t√≤a ƒë√°p √°n tr√πng nhau, ko d√πng t√≤a nh√† ƒë√£ l√† answer ·ªü c√¢u kh√°c
      if(excludeSet.indexOf(x+','+y)===-1)
        eligible.push(cell);
    }
  return shuffle(eligible);
}

// Sinh 3 ƒë√°p √°n cho 3 t√≤a nh√† kh√°c nhau
function createAnswerBuildings(triggerCell) {
  currQuestion = questions.filter(q=>q.level>=difficulty&&!q.used)[0]||questions[Math.floor(Math.random()*questions.length)];
  if(currQuestion && currQuestion.used !== undefined) currQuestion.used=true;
  let qbox = document.querySelector('.question-box');
  qbox.innerText = currQuestion.question;
  // Ch·ªçn 3 t√≤a
  let opts = shuffle(currQuestion.options.slice());
  currAnswers = opts;
  currAnswerBuildings = [];
  // Ch·ªâ ch·ªçn c√°c t√≤a nh√† kh√°c nhau v√† ch∆∞a b·ªã v√¥ hi·ªáu
  let answerPos = []; // l∆∞u tr·ªØ to·∫° ƒë·ªô
  for(let i=0;i<3;i++) {
    let usedPos = answerPos.concat(BUILDINGS.map(b=>({x:b.x,y:b.y})));
    let extra = randomOtherBuildings_exc(answerPos)[0];
    // ƒê·ªÉ ∆∞u ti√™n ch·ªçn lu√¥n c√°c t√≤a c·ªë ƒë·ªãnh l√†m ƒë√°p √°n
    let mainBuilding = BUILDINGS.slice().filter(b=>!gridArr[b.y][b.x].isInactive&&!gridArr[b.y][b.x].isAnswer && !(b.x === triggerCell.x && b.y === triggerCell.y));
    let tgt;
    if(mainBuilding.length>0) tgt = mainBuilding.shift();
    else if (extra) tgt = extra;
    else continue;
    // ƒê√°nh c·ªù "isAnswer"
    gridArr[tgt.y][tgt.x].isAnswer = true;
    gridArr[tgt.y][tgt.x].answerText = currAnswers[i];
    gridArr[tgt.y][tgt.x].isChosen = false;
    answerPos.push({x:tgt.x,y:tgt.y});
    currAnswerBuildings.push({x:tgt.x,y:tgt.y,answer:currAnswers[i]});
  }
  drawGrid();
  awaitingAnswer = true;
}

function removeAnswerBuildings() {
  currAnswerBuildings.forEach(pt=>{
    let cell = gridArr[pt.y][pt.x];
    cell.isAnswer = false; cell.answerText = null; cell.isChosen = false;
  });
  currAnswerBuildings = [];
}

function showQuestionBox() {
  let qbox = document.querySelector('.question-box');
  qbox.innerText = currQuestion.question + "\n(H√£y di chuy·ªÉn ƒë·∫øn 1 to√† nh√† ƒë√°p √°n!)";
  document.querySelector('.question-answers').innerHTML = '';
}

function answerBuildingAction(cell) {
  // Ng∆∞·ªùi ch∆°i ƒë√£ ch·ªçn ƒë√°p √°n b·∫±ng c√°ch ƒëi ƒë·∫øn to√† nh√† ƒë√°p √°n
  let answer = cell.answerText;
  let isRight = (answer === currQuestion.correct);
  // Hu·ª∑ c√°c to√† nh√† ƒë√°p √°n
  removeAnswerBuildings();
  lastChosenCell = {x:cell.x, y:cell.y};
  if(isRight) {
    score++;
    cell.isDone = true;
    difficulty = Math.min(5, difficulty+1);
    doneBuildingCount++;
    document.querySelector('.msg').innerText = "‚úîÔ∏è ƒê√∫ng! Ti·∫øp t·ª•c giao ƒë∆°n m·ªõi.";
    // Th·∫Øng game?
    if(score>=TOTAL_STOP) {
      let bday = {x: COLS-2, y:1};
      gridArr[bday.y][bday.x].isBirthday = true;
    }
  } else {
    // N·∫øu t√≤a n√†y l√† t√≤a c·ªë ƒë·ªãnh th√¨ b·ªã v√¥ hi·ªáu h√≥a
    if(cell.isPickup||cell.isDropoff)
    {
      cell.isInactive=true;
      inactiveBuildings.push({x: cell.x, y: cell.y});
    }
    difficulty = Math.max(1,difficulty-1);
    showMsg(2000,"‚ùå Sai! ƒêi·ªÉm n√†y b·ªã v√¥ hi·ªáu h√≥a!");
    // Thua game khi c√≤n 3 to√†?
    if(inactiveBuildings.length >= TOTAL_STOP-3) {
      setTimeout(()=>showEnd('game-over'),400);
    }
  }
  updateInfo();
  awaitingAnswer = false;
  setTimeout(()=>{
    hideQuestion(); lastChosenCell=null;
    drawGrid();
  }, 900);
}

function showEnd(type) {
  let el = document.getElementById('endScene');
  if (type === 'game-over') {
    el.innerHTML = `<div class="game-over">Thua cu·ªôc! <br/>B·∫°n ƒë√£ h·∫øt to√† nh√† giao nh·∫≠n!</div>`;
    gameOver = true;
  } else {
    el.innerHTML = `<div class="game-win">üéâ Th·∫Øng game!<br/>B·∫°n ƒë√£ ho√†n th√†nh giao h√†ng v√† nh·∫≠n b√°nh sinh nh·∫≠t!</div>`;
    gameWin = true;
  }
}

function gameInit() {
  createGridArr();
  score = 0; doneBuildingCount = 0; inactiveBuildings = [];
  driverPos = {x: BUILDINGS[0].x, y: BUILDINGS[0].y};
  lives=TOTAL_STOP;difficulty=1;awaitingAnswer = false;gameWin=gameOver=false;
  lastChosenCell = null;
  questions.forEach(q=>q.used=false);
  for(let row of gridArr)
    for(let cell of row)
      cell.isDone=false, cell.isInactive=false, cell.isBirthday=false, cell.isAnswer=false, cell.answerText=null;
  hideQuestion();
  updateInfo();
  drawGrid();
  document.getElementById('endScene').innerHTML='';
}
gameInit();
</script>
</body>
</html>
