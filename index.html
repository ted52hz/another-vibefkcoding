<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Game đua xe - Tấn công bằng đạn bay</title>
  <style>
    body {
      background: #222;
      color: #fff;
      text-align: center;
      font-family: Arial, sans-serif;
    }
    h1 { margin-top: 20px; }
    #gameContainer {
      margin: 40px auto;
      width: 400px;
    }
    canvas {
      background: #444;
      display: block;
      margin: 0 auto;
      border-radius: 8px;
      box-shadow: 0 0 12px #000d;
    }
    #restartBtn {
      margin-top: 20px;
      display: none;
      padding: 10px 25px;
      font-size: 1.2rem;
      background: #33c;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #score, #invisibleStatus, #playerHpBar {
      font-size: 1.2rem;
      margin-top: 15px;
    }
    #playerHpBar {
      margin-top: 5px;
    }
    #invisibleStatus { color: #3ff177; }
    #cooldownStatus {
      font-size: 1.1rem;
      color: #e3e82e;
    }
    .hint {
      color: #ccc;
      margin: 10px 0 0 0;
      font-size: 0.97rem;
    }
  </style>
</head>
<body>
  <h1>Game Đua Xe: Bắn Súng Và HP</h1>
  <div class="hint">
    - Nhấn <b>Trái/Phải</b> để lái.<br>
    - Nhấn <b>R</b> để ẩn xe 1.5s (cooldown 5s).<br>
    - Nhấn <b>F</b> hoặc <b>Space</b> để bắn đạn.<br>
    - Đạn sẽ trừ 1 HP xe địch nào bị trúng.<br>
    - Xe bạn có <b>5 HP</b>. Xe địch mỗi xe <b>2 HP</b>.
  </div>
  <div id="gameContainer">
    <canvas id="racingGame" width="400" height="600"></canvas>
    <div id="score">Điểm: 0</div>
    <div id="playerHpBar"></div>
    <div id="invisibleStatus"></div>
    <div id="cooldownStatus"></div>
    <button id="restartBtn">Chơi lại</button>
  </div>
  <script>
    // --- GAME CONST & VARS ---
    const canvas = document.getElementById('racingGame');
    const ctx = canvas.getContext('2d');
    const carWidth = 50, carHeight = 90;
    const PLAYER_INIT_HP = 5;
    let player = {
      x: 175, y: 480, width: carWidth, height: carHeight,
      speed: 6,
      hp: PLAYER_INIT_HP,
      maxHp: PLAYER_INIT_HP
    };

    let obstacles = [];
    let bullets = []; // {x, y, width, height, speed}
    let score = 0;
    let gameOver = false, moveLeft = false, moveRight = false, animationId;

    // --- INVISIBLE ---
    let invisible = false;
    let invisibleStartTime = 0;
    const INVISIBLE_DURATION = 1500; // ms
    let cooldown = false;
    let cooldownStart = 0;
    const COOLDOWN_TIME = 5000; // ms

    // --- UTILS DRAW ---
    function drawRoad() {
      ctx.fillStyle = "#666";
      ctx.fillRect(120, 0, 160, 600);
      // Đường kẻ giữa
      ctx.setLineDash([20, 20]);
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(200, 0);
      ctx.lineTo(200, 600);
      ctx.stroke();
      ctx.setLineDash([]);
    }
    function drawCar(car, color, options={}) {
      // options: {invisible, blink, hitFlash, hpBar}
      if (options.invisible && options.blink) {
        if (Math.floor(Date.now()/80) % 2 === 0) return;
      }
      ctx.save();
      if (options.invisible) {
        ctx.globalAlpha = 0.5;
        color = "#5cf";
      }
      if (options.hitFlash) {
        ctx.globalAlpha = 0.83;
        color = "#fff12e"; // flash vàng khi bị bắn
      }
      ctx.fillStyle = color;
      ctx.fillRect(car.x, car.y, car.width, car.height);
      // Kính lái
      ctx.fillStyle = "#aad";
      ctx.fillRect(car.x+10, car.y+15, car.width-20, 20);
      // Bánh xe
      ctx.fillStyle = "#222";
      ctx.fillRect(car.x-7, car.y+10, 10, 24);
      ctx.fillRect(car.x+car.width-3, car.y+10, 10, 24);
      ctx.fillRect(car.x-7, car.y+car.height-34, 10, 24);
      ctx.fillRect(car.x+car.width-3, car.y+car.height-34, 10, 24);
      // Thanh HP nếu có
      if (options.hpBar) {
        let barW = car.width-10, barH = 7, barX = car.x+5, barY = car.y+car.height-11;
        ctx.strokeStyle = "#111";
        ctx.strokeRect(barX, barY, barW, barH);
        ctx.fillStyle = "#0f0";
        let percent = Math.max(0, car.hp / car.maxHp);
        ctx.fillRect(barX, barY, barW * percent, barH);
      }
      ctx.restore();
    }
    function drawObstacles() {
      for (const obs of obstacles) {
        let isFlashing = obs.hitFlash && (Date.now() - obs.hitFlash < 200);
        drawCar(obs, "#0d8", {hpBar:true, hitFlash:isFlashing});
      }
    }
    function drawBullets() {
      ctx.save();
      for (const b of bullets) {
        ctx.globalAlpha = 0.85;
        ctx.fillStyle = "#ffe145";
        ctx.fillRect(b.x, b.y, b.width, b.height);
        ctx.fillStyle = "#c9ab14";
        ctx.fillRect(b.x+1, b.y, b.width-2, b.height);
      }
      ctx.restore();
    }
    function detectCollision(rect1, rect2) {
      return (rect1.x < rect2.x + rect2.width &&
              rect1.x + rect1.width > rect2.x &&
              rect1.y < rect2.y + rect2.height &&
              rect1.y + rect1.height > rect2.y);
    }
    function handleInput() {
      if (moveLeft && player.x > 130) player.x -= player.speed;
      if (moveRight && player.x < 240) player.x += player.speed;
      if (!moveLeft && !moveRight) {
        if (player.x < 130) player.x = 130;
        else if (player.x > 240) player.x = 240;
      }
    }
    function newObstacle() {
      const laneX = [130, 185, 240]; // 3 làn
      const x = laneX[Math.floor(Math.random()*laneX.length)];
      const w = carWidth, h = carHeight;
      const speed = 3 + Math.random()*2 + score / 50;
      return {x, y: -h, width: w, height: h, speed, hp: 2, maxHp: 2, hitFlash: 0};
    }
    function updateObstacles() {
      for (const obs of obstacles) {
        obs.y += obs.speed;
      }
      if (obstacles.length < 3 || obstacles[obstacles.length-1].y > 160) {
        obstacles.push(newObstacle());
      }
      if (obstacles.length && obstacles[0].y > canvas.height) {
        obstacles.shift();
        score++;
        document.getElementById('score').textContent = `Điểm: ${score}`;
      }
    }
    function updateCooldownStatus() {
      const stDiv = document.getElementById('cooldownStatus');
      if (cooldown) {
        const left = Math.max(0, COOLDOWN_TIME - (Date.now() - cooldownStart));
        stDiv.textContent = "Chờ sử dụng R: " + (left/1000).toFixed(1) + "s";
      } else {
        stDiv.textContent = "";
      }
    }
    function updatePlayerHpBar() {
      const bar = document.getElementById('playerHpBar');
      let per = player.hp / player.maxHp;
      let color = per > 0.6 ? "#0f0" : per > 0.3 ? "#ff0" : "#f30";
      let bars = "";
      for (let i=1;i<=player.maxHp;i++) bars += `<span style="color:${i<=player.hp?color:'#444'};font-weight:bold;font-size:1.1em;">♥</span> `;
      bar.innerHTML = "HP: " + bars;
    }

    // --- BẮN ĐẠN ---
    function playerShoot() {
      // Bắn tại chính giữa đầu xe, chiều rộng đạn nhỏ hơn xe
      let bulletW = 10, bulletH = 24;
      let b = {
        x: player.x + player.width/2 - bulletW/2,
        y: player.y - bulletH + 5,
        width: bulletW,
        height: bulletH,
        speed: 12
      };
      bullets.push(b);
    }

    function updateBullets() {
      // Đạn bay lên và xử lý va chạm
      for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.y -= b.speed;
        // Nếu ngoài màn hình thì loại bỏ
        if (b.y + b.height < 0) {
          bullets.splice(i,1);
          continue;
        }
        // Kiểm tra trúng xe địch (chỉ 1 xe/trúng/lượt)
        for (let j = 0; j < obstacles.length; j++) {
          let obs = obstacles[j];
          if (obs.hp > 0 && detectCollision(b, obs)) {
            obs.hp -= 1;
            obs.hitFlash = Date.now();
            if (obs.hp <= 0) {
              // Delay nhỏ để hiệu ứng flash
              setTimeout(()=>{ if (obstacles[j] === obs) obstacles.splice(j,1); }, 150);
            }
            bullets.splice(i,1);
            break;
          }
        }
      }
    }

    function resetGame() {
      player.x = 175;
      player.hp = player.maxHp = PLAYER_INIT_HP;
      obstacles = [];
      bullets = [];
      score = 0;
      gameOver = false;
      invisible = false;
      cooldown = false;
      document.getElementById('score').textContent = `Điểm: ${score}`;
      document.getElementById('invisibleStatus').textContent = "";
      document.getElementById('restartBtn').style.display = "none";
      document.getElementById('cooldownStatus').textContent = "";
      updatePlayerHpBar();
      animate();
    }

    // --- GAME LOOP ---
    function animate() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawRoad();
      handleInput();
      let blink = (invisible && ((Date.now() - invisibleStartTime) < INVISIBLE_DURATION));
      drawCar(player, "#e33", {invisible, blink});
      updatePlayerHpBar();
      drawObstacles();
      updateObstacles();
      drawBullets();
      updateBullets();

      // Xử lý hết ẩn xe
      if (invisible && (Date.now() - invisibleStartTime) > INVISIBLE_DURATION) {
        invisible = false;
        document.getElementById('invisibleStatus').textContent = "";
      }
      if (invisible && !gameOver) {
        document.getElementById('invisibleStatus').textContent = "Tàng hình! (+1.5 giây)";
      } else {
        document.getElementById('invisibleStatus').textContent = "";
      }

      // Va chạm với xe địch
      if (!invisible && !gameOver) {
        for (const obs of obstacles) {
          if (obs.hp > 0 && detectCollision(player, obs)) {
            player.hp -= 1;
            updatePlayerHpBar();
            if (player.hp <= 0) {
              gameOver = true;
              cancelAnimationFrame(animationId);
              document.getElementById('restartBtn').style.display = "block";
              ctx.font = "bold 48px Arial";
              ctx.fillStyle = "#fff";
              ctx.fillText("THUA!", 140, 310);
              return;
            } else {
              // Để tránh dính nhiều lần, dịch xe địch ra xa một chút
              obs.y += 100;
            }
          }
        }
      }
      // Cooldown R
      if (cooldown) {
        if (Date.now() - cooldownStart >= COOLDOWN_TIME) {
          cooldown = false;
          document.getElementById('cooldownStatus').textContent = "";
        }
      }
      updateCooldownStatus();

      if (!gameOver) {
        animationId = requestAnimationFrame(animate);
      }
    }

    // --- PHÍM ĐIỀU KHIỂN ---
    document.addEventListener('keydown', e => {
      if (e.key === "ArrowLeft" || e.key === "a") moveLeft = true;
      if (e.key === "ArrowRight" || e.key === "d") moveRight = true;
      if ((e.key === "R" || e.key === "r") && !invisible && !cooldown && !gameOver) {
        invisible = true;
        invisibleStartTime = Date.now();
        cooldown = true;
        cooldownStart = Date.now();
        updateCooldownStatus();
      }
      if ((e.key === "f" || e.key === "F" || e.key === " " ) && !gameOver) {
        playerShoot();
      }
    });
    document.addEventListener('keyup', e => {
      if (e.key === "ArrowLeft" || e.key === "a") moveLeft = false;
      if (e.key === "ArrowRight" || e.key === "d") moveRight = false;
    });
    document.getElementById('restartBtn').onclick = resetGame;

    // --- START ---
    resetGame();
  </script>
</body>
</html>
