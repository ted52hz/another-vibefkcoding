<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üéâ AhaMove 10 NƒÉm - Game T√†i X·∫ø Si√™u H·∫°ng</title>
  <style>
    :root{
      /* AhaMove Birthday Theme Colors */
      --primary:#FF6B35; --primary-dark:#E55A2B; --primary-light:#FF8C69;
      --secondary:#FFD23F; --secondary-dark:#E6BD33; --secondary-light:#FFF176;
      --success:#4CAF50; --danger:#F44336; --info:#2196F3;
      --background:#FFF8E1; --panel:#FFFFFF; --card:#FFFDE7;
      --text:#2E2E2E; --text-light:#666666; --border:#FFE0B2;
      --shadow:rgba(255, 107, 53, 0.2); --glow:rgba(255, 210, 63, 0.6);
      
      /* Game specific colors */
      --game-bg:#FFF3E0; --game-grid:#FF8A50; --game-cell:#FFF8F3;
      --pickup-bg:#FFE0B2; --pickup-border:#FF9800; 
      --dropoff-bg:#FFCDD2; --dropoff-border:#F44336;
      --birthday-bg:#E1BEE7; --birthday-border:#9C27B0;
    }
    *{box-sizing:border-box}
    body { 
      font-family: 'Segoe UI', 'Inter', Arial, sans-serif; 
      background: linear-gradient(135deg, var(--background) 0%, #FFECB3 50%, #FFE082 100%);
      margin: 0; 
      color: var(--text);
      overflow-x: hidden;
      position: relative;
    }
    
    /* Birthday confetti animation */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="%23FF6B35" opacity="0.6"><animateTransform attributeName="transform" type="translate" values="0,0; 10,100; 0,200" dur="3s" repeatCount="indefinite"/></circle><circle cx="40" cy="10" r="1.5" fill="%23FFD23F" opacity="0.5"><animateTransform attributeName="transform" type="translate" values="0,0; -5,100; 0,200" dur="2.5s" repeatCount="indefinite"/></circle><circle cx="60" cy="30" r="1" fill="%23FF8C69" opacity="0.4"><animateTransform attributeName="transform" type="translate" values="0,0; 8,100; 0,200" dur="3.5s" repeatCount="indefinite"/></circle><circle cx="80" cy="15" r="2" fill="%23FFF176" opacity="0.6"><animateTransform attributeName="transform" type="translate" values="0,0; -10,100; 0,200" dur="2.8s" repeatCount="indefinite"/></circle></svg>') repeat;
      pointer-events: none;
      z-index: -1;
      opacity: 0.3;
    }
    h3{margin:8px 0 6px}
    
    /* Main Layout - Three Column */
    .container { 
      display: grid; 
      grid-template-columns: 300px 1fr 320px; 
      gap: 20px; 
      padding: 20px; 
      min-height: 100vh;
      max-width: 1600px;
      margin: 0 auto;
    }
    
    /* Left Panel - Game Info Only */
    .game-info { 
      background: linear-gradient(135deg, var(--panel) 0%, var(--card) 100%);
      border-radius: 20px; 
      box-shadow: 0 8px 32px var(--shadow), 0 0 0 2px var(--border); 
      padding: 24px;
      border: 2px solid var(--primary-light);
      text-align: center; 
      line-height: 1.6;
      position: sticky;
      top: 20px;
      height: fit-content;
      position: relative;
      overflow: hidden;
    }
    
    /* AhaMove branding header */
    .game-info::before {
      content: 'üéâ AHAMOVE 10 NƒÇM üéÇ';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 8px;
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      border-radius: 20px 20px 0 0;
      margin: -2px -2px 0 -2px;
    }
    
    .game-info .content {
      margin-top: 20px;
    }
    
    /* Center - Game Grid */
    .city-wrap {
      position: relative; 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: flex-start;
      gap: 20px; 
      padding: 20px 0;
    }
    
    /* Right Panel - Question Management */
    .right-panel {
      position: relative;
    }
    
    .question-status {
      background: var(--panel); 
      border-radius: 16px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.3);
      margin-bottom: 15px;
      text-align: center;
    }
    
    .current-question-set {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(51, 190, 253, 0.1);
      border-radius: 10px;
      border-left: 4px solid var(--accent);
    }
    
    .question-set-info {
      flex: 1;
    }
    
    .question-set-title {
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 5px;
    }
    
    .question-set-details {
      font-size: 13px;
      color: #666;
    }
    
    .toggle-llm-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .toggle-llm-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .toggle-llm-btn:active {
      transform: translateY(0);
    }
    
    /* LLM Panel - Initially Hidden */
    .llm-panel {
      background: var(--panel); 
      border-radius: 16px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.1); 
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.3);
      transition: all 0.3s ease;
      transform-origin: top;
      overflow: hidden;
    }
    
    .llm-panel.hidden {
      max-height: 0;
      padding: 0 20px;
      opacity: 0;
      transform: scaleY(0);
      margin-bottom: 0;
    }
    
    .llm-panel.visible {
      max-height: 1000px;
      opacity: 1;
      transform: scaleY(1);
      margin-bottom: 0;
    }
    
    .score, .lives, .question-level { 
      font-weight: bold; 
      font-size: 18px; 
      color: var(--accent);
    }
    
    .question-box { 
      min-height: 60px; 
      margin: 12px 0; 
      border: 2px dashed #66c; 
      border-radius: 12px; 
      background: #f7f7fc; 
      padding: 12px; 
      text-align: left;
      font-size: 14px;
      line-height: 1.4;
    }
    
    .answer-list {
      margin:0; 
      padding-left:0; 
      list-style-type:none; 
      text-align:left;
    }
    
    .answer-list li {
      background: linear-gradient(135deg, #e2faff 0%, #f0fdff 100%);
      border-radius: 10px;
      margin: 8px 0;
      padding: 10px 12px;
      border-left: 4px solid #33befd;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    
    .answer-list li:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .answer-tag {
      background: linear-gradient(135deg, #f6e741 0%, #f9ec47 100%);
      font-weight: bold;
      font-size: 1.1em;
      color: #6b4c00;
      border-radius: 8px;
      padding: 4px 10px;
      min-width: 32px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .answer-coord {
      color: #227a24;
      font-weight: bold;
      font-size: .95em;
      background: #eaffed;
      border-radius: 6px;
      padding: 4px 10px;
      margin-left: auto;
      white-space: nowrap;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Game Grid */
    .grid { 
      display: grid; 
      grid-template-columns: repeat(12, 40px); 
      grid-template-rows: repeat(12, 40px); 
      background: linear-gradient(135deg, var(--game-bg) 0%, #FFCC80 100%); 
      border: 6px solid var(--game-grid); 
      border-radius: 20px; 
      box-shadow: 0 12px 48px var(--shadow), 0 0 0 3px var(--secondary-light); 
      position: relative;
      margin: 0 auto;
    }
    
    /* Game title above grid */
    .grid::before {
      content: 'üöö AhaMove 10 NƒÉm - Game T√†i X·∫ø Si√™u H·∫°ng';
      position: absolute;
      top: -45px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 4px 16px var(--shadow);
      white-space: nowrap;
    }
    
    .cell { 
      border: 1px solid var(--border); 
      background: var(--game-cell); 
      height: 40px; 
      width: 40px; 
      position: relative; 
      display: flex; 
      justify-content: center; 
      align-items: center;
      transition: all 0.3s ease;
      border-radius: 4px;
    }
    
    /* Custom driver with image support */
    .driver { 
      font-size: 1.6rem; 
      z-index: 2; 
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
      animation: driverBounce 2s ease-in-out infinite;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
    }
    
    .driver img {
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
    }
    
    @keyframes driverBounce {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-2px); }
    }
    
    /* Custom driver image - Replace with your driver image */
    .driver.custom-image {
      width: 36px;
      height: 36px;
      background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23FF6B35"/><circle cx="50" cy="40" r="15" fill="%23FFF"/><circle cx="45" cy="38" r="2" fill="%23333"/><circle cx="55" cy="38" r="2" fill="%23333"/><path d="M40 50 Q50 60 60 50" stroke="%23333" stroke-width="2" fill="none"/><text x="50" y="80" text-anchor="middle" font-size="12" fill="%23FFF">üèçÔ∏è</text></svg>');
      background-size: cover;
      background-position: center;
      border-radius: 50%;
      border: 3px solid var(--primary);
      box-shadow: 0 0 15px var(--glow);
      font-size: 0; /* Hide emoji when using background image */
    }
    
    /* Placeholder for motorcycle image */
    .vehicle-icon {
      position: absolute;
      bottom: -5px;
      right: -5px;
      width: 16px;
      height: 16px;
      background: var(--secondary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      border: 2px solid white;
    }
    
    /* Instructions for adding custom images */
    .custom-image-instructions {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--panel);
      border: 2px solid var(--primary);
      border-radius: 12px;
      padding: 15px;
      max-width: 300px;
      font-size: 12px;
      box-shadow: 0 4px 20px var(--shadow);
      z-index: 1000;
      display: none;
    }
    
    .custom-image-instructions.show {
      display: block;
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .pickup, .pickup.active { 
      font-size: 1.3rem; 
      font-weight: bold; 
      border-radius: 12px; 
      background: var(--pickup-bg); 
      border: 2px solid var(--pickup-border); 
      width: 32px; 
      height: 32px; 
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .pickup img, .dropoff img {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    .pickup.active { 
      background: linear-gradient(135deg, var(--secondary-light) 0%, var(--secondary) 100%); 
      border: 3px solid var(--primary); 
      box-shadow: 0 0 20px var(--glow), 0 6px 20px rgba(0,0,0,0.3);
      animation: ahamovePulse 2s infinite;
      transform: scale(1.1);
    }
    
    .dropoff, .dropoff.active { 
      font-size: 1.3rem; 
      font-weight: bold; 
      border-radius: 12px; 
      background: var(--dropoff-bg); 
      border: 2px solid var(--dropoff-border); 
      width: 32px; 
      height: 32px; 
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .dropoff.active { 
      background: linear-gradient(135deg, #FFCDD2 0%, #EF5350 100%); 
      border: 3px solid var(--danger); 
      box-shadow: 0 0 20px rgba(244, 67, 54, 0.6), 0 6px 20px rgba(0,0,0,0.3);
      animation: ahamovePulse 2s infinite;
      transform: scale(1.1);
    }
    
    @keyframes ahamovePulse {
      0%, 100% { 
        transform: scale(1.1); 
        box-shadow: 0 0 20px var(--glow), 0 6px 20px rgba(0,0,0,0.3);
      }
      50% { 
        transform: scale(1.2); 
        box-shadow: 0 0 30px var(--glow), 0 8px 25px rgba(0,0,0,0.4);
      }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    .birthday { 
      background: linear-gradient(135deg, var(--birthday-bg) 0%, #CE93D8 100%); 
      color: #4A148C; 
      border-radius: 15px; 
      width: 36px; 
      height: 36px; 
      font-size: 1.5rem; 
      display: flex;
      align-items: center;
      justify-content: center; 
      border: 3px solid var(--birthday-border);
      box-shadow: 0 0 25px #E1BEE7, 0 0 50px rgba(156, 39, 176, 0.3);
      animation: birthdayCelebration 1.5s infinite alternate;
      position: relative;
      overflow: hidden;
    }
    
    .birthday img {
      filter: drop-shadow(0 3px 6px rgba(0,0,0,0.4));
    }
    
    .birthday::before {
      content: '‚ú®';
      position: absolute;
      top: -8px;
      right: -8px;
      font-size: 12px;
      animation: sparkle 1s infinite;
    }
    
    .birthday::after {
      content: 'üéä';
      position: absolute;
      bottom: -8px;
      left: -8px;
      font-size: 12px;
      animation: sparkle 1s infinite 0.5s;
    }
    
    @keyframes birthdayCelebration {
      0% { 
        transform: rotate(-8deg) scale(1); 
        box-shadow: 0 0 25px #E1BEE7, 0 0 50px rgba(156, 39, 176, 0.3);
      }
      100% { 
        transform: rotate(8deg) scale(1.15); 
        box-shadow: 0 0 35px #E1BEE7, 0 0 70px rgba(156, 39, 176, 0.5);
      }
    }
    
    @keyframes sparkle {
      0%, 100% { opacity: 0; transform: scale(0.5) rotate(0deg); }
      50% { opacity: 1; transform: scale(1) rotate(180deg); }
    }
    
    .inactive { 
      background: #888; 
      color: #fff; 
      border-radius: 12px; 
      width: 32px; 
      height: 32px; 
      font-size: 1.1rem; 
      opacity: .7;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .answer-building { 
      background: #fffce0 !important; 
      border: 2px solid #b3a500 !important;
      box-shadow: 0 0 12px rgba(255,215,0,0.5) !important;
    }
    
    /* Answer codes styling with distinct colors */
    .answer-code-A span { 
      background: linear-gradient(135deg, #f6e741 0%, #e6d535 100%) !important; 
      color: #6b4c00 !important;
      box-shadow: 0 3px 8px rgba(246, 231, 65, 0.4) !important;
    }
    .answer-code-B span { 
      background: linear-gradient(135deg, #ffba10 0%, #e6a50f 100%) !important; 
      color: #8b5a00 !important;
      box-shadow: 0 3px 8px rgba(255, 186, 16, 0.4) !important;
    }
    .answer-code-C span { 
      background: linear-gradient(135deg, #28d857 0%, #24c24f 100%) !important; 
      color: #0a5d1a !important;
      box-shadow: 0 3px 8px rgba(40, 216, 87, 0.4) !important;
    }
    
    .chosen-wrong { 
      background: #fcb4b4 !important; 
      border: 2px solid #b21d1d !important;
      animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .obstacle {
      background: transparent;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    
    .obstacle img {
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }
    
    .msg { 
      color: var(--ink); 
      font-size: 14px; 
      min-height: 20px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
    }
    
    /* Enhanced Modal Popups */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .game-over-modal, .game-win-modal { 
      background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: scale(0.9);
      animation: modalPop 0.4s ease-out forwards;
      max-width: 400px;
      width: 90%;
      border: 3px solid;
    }
    
    .game-over-modal {
      border-color: #e74c3c;
      color: #c0392b;
    }
    
    .game-win-modal {
      border-color: #27ae60;
      color: #16a085;
    }
    
    @keyframes modalPop {
      from { 
        transform: scale(0.7) translateY(-50px);
        opacity: 0;
      }
      to { 
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }
    
    .modal-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      display: block;
    }
    
    .modal-title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 15px;
    }
    
    .modal-message {
      font-size: 1.2rem;
      margin-bottom: 25px;
      line-height: 1.5;
    }
    
    .modal-stats {
      background: rgba(0,0,0,0.05);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 25px;
      font-size: 1.1rem;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }
    
    .modal-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 1.1rem;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .modal-btn-primary {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
    }
    
    .modal-btn-secondary {
      background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
      color: white;
    }
    
    .modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    
    .modal-btn:active {
      transform: translateY(0);
    }
    
    /* Controls */
    .controller { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      margin: 10px 0;
      background: rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 15px;
    }
    
    .ctrl-btns { 
      display: flex; 
      flex-direction: row; 
      gap: 15px;
    }
    
    .ctrl-up, .ctrl-down, .ctrl-left, .ctrl-right, .btn { 
      padding: 8px 12px; 
      min-width: 40px; 
      height: 40px; 
      text-align: center; 
      font-size: 16px; 
      border-radius: 10px; 
      background: linear-gradient(135deg, #e4f6ff 0%, #cdeeff 100%); 
      cursor: pointer; 
      border: 1px solid #7ac5f5; 
      margin: 2px; 
      user-select: none;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.15s ease;
    }
    
    .ctrl-up:hover, .ctrl-down:hover, .ctrl-left:hover, .ctrl-right:hover, .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .ctrl-up:active, .ctrl-down:active, .ctrl-left:active, .ctrl-right:active, .btn:active {
      background: #b0ebfb;
      transform: translateY(1px);
    }
    
    .hl {font-weight:700}
    
    /* LLM panel specific styles */
    .llm-panel small{opacity:.8}
    .llm-grid{display:grid; grid-template-columns: 1fr; gap:12px;}
    .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    label{font-size:13px; min-width:88px; font-weight: 500;}
    input[type="password"], input[type="text"], select, textarea {
      width: 100%; 
      padding: 10px 12px; 
      border: 1px solid #cbd5e1; 
      border-radius: 8px; 
      background: #fff;
      transition: all 0.2s ease;
    }
    
    input[type="password"]:focus, input[type="text"]:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(51, 190, 253, 0.1);
    }
    
    textarea{min-height:110px; resize:vertical}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace; font-size:12.5px}
    .pill{display:inline-block; padding:4px 12px; border-radius:999px; background:#e8f7ff; border:1px solid #bfe7ff; font-size:12px; font-weight: 500;}
    .status{min-height:18px; font-size:13px; padding: 8px; border-radius: 6px;}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .kbd{font-family:ui-monospace,monospace; font-size:12px; background:#eef; border:1px solid #dde; border-bottom-width:2px; padding:2px 6px; border-radius:4px}
    .flex-between{display:flex; align-items:center; justify-content:space-between}
    
    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        grid-template-columns: 280px 1fr 300px;
      }
    }
    
    @media (max-width: 960px) {
      .container {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .right-panel {
        order: -1;
      }
      
      .grid {
        grid-template-columns: repeat(12, 32px);
        grid-template-rows: repeat(12, 32px);
      }
      
      .cell {
        height: 32px;
        width: 32px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LEFT: Game info + Controls -->
    <div class="game-info">
      <div class="content">
        <div class="flex-between">
          <div><b>üèçÔ∏è T√†i x·∫ø AhaMove:</b> <span style="color: var(--primary);">Hero Driver</span></div>
          <button class="btn" id="btnReset" title="Ch∆°i l·∫°i" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; border: none;">üîÑ</button>
        </div>
        <div style="margin-top:12px; padding: 8px; background: linear-gradient(135deg, var(--card) 0%, #FFF8E1 100%); border-radius: 10px;">
          <div><span class="score" style="color: var(--primary);">ƒêi·ªÉm: 0</span> | <span class="lives" style="color: var(--danger);">Nh√† c√≤n: 5</span></div>
          <div class="question-level" style="color: var(--secondary-dark);">ƒê·ªô kh√≥: 1</div>
        </div>
        <hr style="margin: 15px 0; border: none; height: 2px; background: linear-gradient(to right, transparent, var(--primary), transparent);">
      <div class="question-box"></div>
      <ul class="answer-list"></ul>
      <div class="msg"></div>
        <hr style="margin: 15px 0; border: none; height: 2px; background: linear-gradient(to right, transparent, var(--primary), transparent);">
      <div class="controller">
          <div><b>üéÆ ƒêi·ªÅu khi·ªÉn</b> <span class="pill" style="background: var(--secondary-light); color: var(--text);">Ph√≠m m≈©i t√™n</span></div>
          <div style="margin-top:10px">
          <button class="ctrl-up" title="L√™n">‚¨ÜÔ∏è</button>
        </div>
        <div class="ctrl-btns">
          <button class="ctrl-left" title="Tr√°i">‚¨ÖÔ∏è</button>
          <button class="ctrl-down" title="Xu·ªëng">‚¨áÔ∏è</button>
          <button class="ctrl-right" title="Ph·∫£i">‚û°Ô∏è</button>
        </div>
          <div style="margin-top: 10px; font-size: 11px; color: var(--text-light); text-align: center;">
            üéØ M·ª•c ti√™u: Giao 5 ƒë∆°n h√†ng th√†nh c√¥ng!<br>
            üéÇ Nh·∫≠n b√°nh sinh nh·∫≠t khi ho√†n th√†nh!
      </div>
          <div style="margin-top: 10px; text-align: center;">
            <button class="btn" id="btnCustomImage" title="H∆∞·ªõng d·∫´n th√™m h√¨nh ·∫£nh t√πy ch·ªânh" style="font-size: 11px; padding: 4px 8px; background: linear-gradient(135deg, var(--info) 0%, #1976D2 100%); color: white; border: none;">
              üñºÔ∏è T√πy ch·ªânh h√¨nh ·∫£nh
            </button>
    </div>
        </div>
      </div>
    </div>

    <!-- CENTER: Game Grid -->
    <div class="city-wrap">
      <div id="gameGrid" class="grid" aria-label="B·∫£n ƒë·ªì th√†nh ph·ªë 12x12"></div>
      <div id="endScene"></div>
    </div>

    <!-- RIGHT: Question Management -->
    <div class="right-panel">
      <!-- Question Status -->
      <div class="question-status">
        <h3>üéì B·ªô c√¢u h·ªèi AhaMove</h3>
        <div class="current-question-set">
          <div class="question-set-info">
            <div class="question-set-title" id="questionSetTitle" style="color: var(--primary);">H√†nh tr√¨nh 10 nƒÉm AhaMove</div>
            <div class="question-set-details" id="questionSetDetails" style="color: var(--text-light);">2015-2025 ‚Ä¢ C√¢u chuy·ªán th√†nh c√¥ng ‚Ä¢ 12 c√¢u h·ªèi</div>
  </div>
          <button class="toggle-llm-btn" id="toggleLlmBtn" style="background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);">
            ü§ñ T·∫°o m·ªõi
          </button>
        </div>
        <div style="font-size: 13px; color: var(--text-light); text-align: left; background: var(--card); padding: 10px; border-radius: 8px; border-left: 3px solid var(--primary);">
          <strong style="color: var(--primary);">üìä Th·ªëng k√™ ki·∫øn th·ª©c:</strong><br>
          ‚Ä¢ T·ªïng c√¢u h·ªèi: <span id="totalQuestions" style="color: var(--success);">12</span><br>
          ‚Ä¢ ƒê·ªô kh√≥ 1-2: <span id="easyQuestions" style="color: var(--info);">4</span> c√¢u (D·ªÖ)<br>
          ‚Ä¢ ƒê·ªô kh√≥ 3-5: <span id="hardQuestions" style="color: var(--danger);">8</span> c√¢u (Kh√≥)<br>
          <small style="color: var(--text-light); font-style: italic;">üí° C√¢u h·ªèi v·ªÅ l·ªãch s·ª≠, d·ªãch v·ª• v√† c√¥ng ngh·ªá AhaMove</small>
        </div>
      </div>

      <!-- LLM Panel - Initially Hidden -->
      <div class="llm-panel hidden" id="llmPanel">
        <h3>üß† T·∫°o b·ªô c√¢u h·ªèi b·∫±ng OpenAI</h3>
        <div class="llm-grid">
          <div class="row">
            <label for="apiKey">API Key</label>
            <input id="apiKey" type="password" placeholder="sk-..." autocomplete="off">
          </div>
          <div class="row">
            <label for="model">Model</label>
            <select id="model">
              <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
              <option value="gpt-4.1-mini">gpt-4.1-mini</option>
              <option value="gpt-4o">gpt-4o</option>
            </select>
          </div>
          <div class="two">
            <div class="row">
              <label for="qCount">S·ªë c√¢u</label>
              <input id="qCount" type="text" value="10" inputmode="numeric">
            </div>
            <div class="row">
              <label for="lang">Ng√¥n ng·ªØ</label>
              <select id="lang">
                <option value="vi" selected>Ti·∫øng Vi·ªát</option>
                <option value="en">English</option>
              </select>
            </div>
          </div>
          <div class="row">
            <label for="kb">Knowledge Base</label>
            <textarea id="kb" class="mono" placeholder="D√°n n·ªôi dung ki·∫øn th·ª©c (v√≠ d·ª•: th√¥ng tin c√°c qu·∫≠n huy·ªán, ƒë·ªãa danh, to√† nh√†, tuy·∫øn ƒë∆∞·ªùng, lu·∫≠t giao th√¥ng, v.v.)"></textarea>
          </div>
          <div class="row">
            <label for="seed">Seed</label>
            <input id="seed" type="text" value="42" title="Gi√∫p k·∫øt qu·∫£ ·ªïn ƒë·ªãnh h∆°n (n·∫øu model h·ªó tr·ª£)">
          </div>
          <div class="row">
            <button class="btn" id="btnGen">üöÄ T·∫°o c√¢u h·ªèi</button>
            <button class="btn" id="btnPreview">üëÄ Xem JSON</button>
            <button class="btn" id="btnImport">üì• Nh·∫≠p JSON</button>
          </div>
          <div class="status" id="llmStatus"></div>
          <details>
            <summary class="pill">H∆∞·ªõng d·∫´n &amp; Schema</summary>
            <div style="margin-top:12px; font-size:13px">
              Tr·∫£ v·ªÅ JSON m·∫£ng c√°c ph·∫ßn t·ª≠:
              <pre class="mono" style="white-space:pre-wrap;background:#fff;padding:12px;border:1px solid #dde;border-radius:8px; margin: 8px 0;">
[
  {
    "question": "string",
    "options": ["optA", "optB", "optC"],
    "correct": "one of options",
    "level": 1
  },
  ...
]</pre>
              <div>G·ª£i √Ω ƒë·ªô kh√≥: 1‚Üír·∫•t d·ªÖ ... 5‚Üíkh√≥.</div>
            </div>
          </details>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Image Instructions -->
  <div class="custom-image-instructions" id="customImageInstructions">
    <h4 style="color: var(--primary); margin-top: 0;">üñºÔ∏è H∆∞·ªõng d·∫´n th√™m h√¨nh ·∫£nh t√πy ch·ªânh</h4>
    <div style="line-height: 1.4;">
      <strong>ƒê·ªÉ th√™m h√¨nh ·∫£nh t√†i x·∫ø:</strong><br>
      1. Chu·∫©n b·ªã file ·∫£nh (PNG/JPG, k√≠ch th∆∞·ªõc 64x64px)<br>
      2. Upload l√™n hosting (imgur, cloudinary, etc.)<br>
      3. Thay th·∫ø URL trong CSS class <code>.driver.custom-image</code><br><br>
      
      <strong>ƒê·ªÉ th√™m h√¨nh ·∫£nh xe m√°y:</strong><br>
      1. Thay ƒë·ªïi emoji üöö trong drawGrid()<br>
      2. Ho·∫∑c th√™m background-image cho .driver<br><br>
      
      <strong>Code m·∫´u:</strong><br>
      <code style="font-size: 10px; background: #f5f5f5; padding: 2px;">
        .driver { background-image: url('your-image.png'); }
      </code>
    </div>
    <div style="margin-top: 10px; text-align: right;">
      <button onclick="toggleCustomImageInstructions()" style="background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;">ƒê√≥ng</button>
    </div>
  </div>

<script>
/* =========================
   Core Game State & Board
   ========================= */
const ROWS = 12, COLS = 12, TOTAL_STOP = 5;
const BUILDINGS = [
  {x: 1, y: 1, type:"pickup"},
  {x: 6, y: 2, type:"dropoff"},
  {x: 2, y: 7, type:"pickup"},
  {x: 9, y: 3, type:"dropoff"},
  {x: 6, y: 10, type:"pickup"},
  {x: 10, y: 8, type:"dropoff"},
  {x: 4, y: 5, type:"pickup"},
  {x: 8, y: 7, type:"dropoff"},
  {x: 2, y: 10, type:"pickup"},
  {x: 9, y: 9, type:"dropoff"}
];
const OBSTACLES = [
  {x:3, y:1},{x:4,y:1},{x:5,y:1},{x:7,y:3},{x:8,y:4},{x:2,y:3},{x:3,y:8},
  {x:0,y:11},{x:1,y:11},{x:2,y:11},{x:8,y:6}, {x:6,y:6}, {x:4,y:9},
  {x:5,y:7}, {x:1, y:8},{x:7,y:11},{x:7,y:10},{x:7,y:9},{x:7,y:8},{x:9,y:0},{x:8,y:0},{x:7,y:0}
];

/* ======= AhaMove 10th Anniversary Question Bank ======= */
let questions = [
  // Level 1 - Kh·ªüi ƒë·∫ßu (2015-2017)
  {question:'üéÇ AhaMove ƒë∆∞·ª£c th√†nh l·∫≠p v√†o nƒÉm n√†o, ƒë√°nh d·∫•u kh·ªüi ƒë·∫ßu h√†nh tr√¨nh 10 nƒÉm?', options:['2015','2016','2018'], correct:'2015', level:1},
  {question:'üöö Slogan ƒë·∫ßu ti√™n c·ªßa AhaMove g·∫ßn v·ªõi √Ω t∆∞·ªüng n√†o?', options:['"Uber for trucks"','Food delivery app','Taxi booking service'], correct:'"Uber for trucks"', level:1},
  
  // Level 2 - Ph√°t tri·ªÉn (2016-2018)
  {question:'üèçÔ∏è AhaMove m·ªü r·ªông d·ªãch v·ª• xe m√°y t·∫°i H√† N·ªôi v√†o nƒÉm n√†o?', options:['2016','2017','2018'], correct:'2016', level:2},
  {question:'üí∞ D·ªãch v·ª• "Si√™u R·∫ª" - t√≠nh nƒÉng ti·∫øt ki·ªám chi ph√≠ ra m·∫Øt nƒÉm n√†o?', options:['2017','2019','2021'], correct:'2017', level:2},
  
  // Level 3 - ƒê·ªïi m·ªõi (2018-2020)
  {question:'üì± "ƒê·ªìng Gi√°" c·ªßa AhaMove mang l·∫°i l·ª£i √≠ch g√¨ cho kh√°ch h√†ng?', options:['Ph√≠ c·ªë ƒë·ªãnh, d·ªÖ t√≠nh to√°n','Mi·ªÖn ph√≠ giao h√†ng','T√≠ch ƒëi·ªÉm ƒë·ªïi qu√†'], correct:'Ph√≠ c·ªë ƒë·ªãnh, d·ªÖ t√≠nh to√°n', level:3},
  {question:'ü¶† COVID-19 (2021) bu·ªôc AhaMove ph·∫£i ƒëi·ªÅu ch·ªânh nh∆∞ th·∫ø n√†o?', options:['H·∫°n ch·∫ø li√™n qu·∫≠n, ƒëi·ªÅu ch·ªânh gi·ªù ho·∫°t ƒë·ªông','T·∫°m ng·ª´ng ho√†n to√†n','Ch·ªâ giao ƒë·ªì ƒÉn'], correct:'H·∫°n ch·∫ø li√™n qu·∫≠n, ƒëi·ªÅu ch·ªânh gi·ªù ho·∫°t ƒë·ªông', level:3},
  
  // Level 4 - B·ª©t ph√° (2019-2022)
  {question:'üíé Temasek ƒë·∫ßu t∆∞ v√†o Scommerce (AhaMove + GHN) nƒÉm n√†o?', options:['2019','2020','2022'], correct:'2019', level:4},
  {question:'‚ö° AhaMove pilot xe ƒëi·ªán v·ªõi VinFast, s·ª≠ d·ª•ng model n√†o?', options:['Feliz S','Klara S','Theon S'], correct:'Feliz S', level:4},
  {question:'‚òÅÔ∏è C√¥ng ngh·ªá MongoDB Atlas c·ªßa AhaMove ch·∫°y tr√™n platform n√†o?', options:['AWS','Azure','Google Cloud'], correct:'AWS', level:4},
  {question:'üó∫Ô∏è Geospatial query gi√∫p AhaMove t·ªëi ∆∞u ƒëi·ªÅu g√¨?', options:['Gh√©p ƒë∆°n v√† ƒë·ªãnh tuy·∫øn th√¥ng minh','D·ª± b√°o th·ªùi ti·∫øt','Ph√¢n t√≠ch c·∫£m x√∫c kh√°ch h√†ng'], correct:'Gh√©p ƒë∆°n v√† ƒë·ªãnh tuy·∫øn th√¥ng minh', level:4},
  
  // Level 5 - T∆∞∆°ng lai (2023-2025)
  {question:'üéØ Ng√†y 25/03/2024, AhaMove ra m·∫Øt brand promise n√†o?', options:['"Giao si√™u r·∫ª, nh·∫≠n si√™u t·ªëc"','"Nhanh nh∆∞ ch·ªõp"','"Lu√¥n ƒë√∫ng h·∫πn"'], correct:'"Giao si√™u r·∫ª, nh·∫≠n si√™u t·ªëc"', level:5},
  {question:'ü§ñ Aha AI (GenAI) ƒë∆∞·ª£c pilot t·∫°i th√†nh ph·ªë n√†o ƒë·∫ßu ti√™n nƒÉm 2024?', options:['ƒê√† N·∫µng','TP.HCM','H√† N·ªôi'], correct:'ƒê√† N·∫µng', level:5}
];

const ANSWER_LABELS = ['A', 'B', 'C'];

let gridArr = [];
let score=0, difficulty = 1, currQuestion = null, currAnswers = [];
let currAnswerBuildings = [];
let answerMetaList = [];
let inactiveBuildings = [];
let activeBuildingIndex = 0;
let driverPos = { x: 0, y: 0 };
let lockAction = false, gameOver = false, gameWin = false;
let lastChosenCell = null;
let isLlmPanelVisible = false;
let currentQuestionSetInfo = {
  title: "H√†nh tr√¨nh 10 nƒÉm AhaMove",
  description: "2015-2025 ‚Ä¢ C√¢u chuy·ªán th√†nh c√¥ng",
  isCustom: false
};

function createGridArr() {
  gridArr = [];
  for (let y = 0; y < ROWS; y++) {
    let row = [];
    for (let x = 0; x < COLS; x++) {
      row.push({
        x, y,
        isPickup: false, isDropoff: false,
        isInactive: false, isBirthday: false,
        isObstacle: false,
        isAnswer: false, answerText: null,
        isDone: false, isActive: false,
        answerCode: null
      });
    }
    gridArr.push(row);
  }
  BUILDINGS.forEach((pt,idx) => {
    if (pt.type == "pickup") gridArr[pt.y][pt.x].isPickup = true;
    if (pt.type == "dropoff") gridArr[pt.y][pt.x].isDropoff = true;
    gridArr[pt.y][pt.x].buildingIndex = idx;
  });
  OBSTACLES.forEach(pt => { gridArr[pt.y][pt.x].isObstacle = true; });
}

function drawGrid() {
  let gridDiv = document.getElementById('gameGrid');
  gridDiv.innerHTML = '';
  for (let y = 0; y < ROWS; y++) {
    for (let x = 0; x < COLS; x++) {
      let cell = gridArr[y][x];
      let html = '';
      let classes = "";
      if(cell.isObstacle) {
        classes += " obstacle";
        html = `<img src="tree.png" alt="Tree" style="width: 30px; height: 30px; object-fit: contain;">`;
      }
      else if (cell.isAnswer) {
        classes += " answer-building";
        if(cell.answerCode) classes += " answer-code-" + cell.answerCode;
        html = `<div><span title="ƒê√°p √°n: ${cell.answerText}" style="font-size: 28px; font-weight: 900; color: #fff; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); background: rgba(0,0,0,0.3); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">${cell.answerCode || ""}</span></div>`;
        if(lastChosenCell && lastChosenCell.x === x && lastChosenCell.y === y)
            classes += " chosen-wrong";
      }
      else if (cell.isInactive) html = `<div class="inactive" title="ƒê√£ v√¥ hi·ªáu ho√°">‚ùå</div>`;
      else if (cell.isBirthday) html = `<div class="birthday" title="Sinh nh·∫≠t"><img src="banh.png" alt="Birthday Cake" style="width: 32px; height: 32px; object-fit: contain;"></div>`;
      else if (cell.isPickup) html = `<div class="pickup${cell.isActive?' active':''}" title="${cell.isActive?'ƒêi·ªÉm m·ª•c ti√™u':'Pickup'}"><img src="building.png" alt="Building" style="width: 28px; height: 28px; object-fit: contain;"></div>`;
      else if (cell.isDropoff) html = `<div class="dropoff${cell.isActive?' active':''}" title="${cell.isActive?'ƒêi·ªÉm m·ª•c ti√™u':'Drop-off'}"><img src="building.png" alt="Building" style="width: 28px; height: 28px; object-fit: contain;"></div>`;
      if(driverPos.x === x && driverPos.y === y) {
        html = `<div class="driver" title="T√†i x·∫ø AhaMove"><img src="xe.png" alt="Vehicle" style="width: 32px; height: 32px; object-fit: contain;"></div>`;
      }
      gridDiv.innerHTML += `<div class="cell${classes}">${html}</div>`;
    }
  }
}

function updateInfo() {
  document.querySelector('.score').innerText = `ƒêi·ªÉm: ${score}`;
  document.querySelector('.lives').innerText = `Nh√† c√≤n: ${TOTAL_STOP - inactiveBuildings.length}`;
  document.querySelector('.question-level').innerText = `ƒê·ªô kh√≥: ${difficulty}`;
}

function updateQuestionSetInfo() {
  document.getElementById('questionSetTitle').textContent = currentQuestionSetInfo.title;
  document.getElementById('questionSetDetails').textContent = 
    `${currentQuestionSetInfo.description} ‚Ä¢ ${questions.length} c√¢u h·ªèi`;
  
  // Update statistics
  const total = questions.length;
  const easy = questions.filter(q => q.level <= 2).length;
  const hard = questions.filter(q => q.level >= 3).length;
  
  document.getElementById('totalQuestions').textContent = total;
  document.getElementById('easyQuestions').textContent = easy;
  document.getElementById('hardQuestions').textContent = hard;
  
  // Update toggle button
  const toggleBtn = document.getElementById('toggleLlmBtn');
  if (isLlmPanelVisible) {
    toggleBtn.innerHTML = '‚ùå ƒê√≥ng';
    toggleBtn.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
  } else {
    toggleBtn.innerHTML = currentQuestionSetInfo.isCustom ? 'üîß Ch·ªânh s·ª≠a' : 'ü§ñ T·∫°o m·ªõi';
    toggleBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
  }
}

function toggleLlmPanel() {
  const llmPanel = document.getElementById('llmPanel');
  isLlmPanelVisible = !isLlmPanelVisible;
  
  if (isLlmPanelVisible) {
    llmPanel.classList.remove('hidden');
    llmPanel.classList.add('visible');
  } else {
    llmPanel.classList.remove('visible');
    llmPanel.classList.add('hidden');
  }
  
  updateQuestionSetInfo();
}

function hideQuestion() {
  document.querySelector('.question-box').innerText = '';
  document.querySelector('.answer-list').innerHTML = '';
  document.querySelector('.msg').innerText = '';
}

function showMsg(t,msg) {
  const m = document.querySelector('.msg');
  m.innerText = msg;
  if(t>0) setTimeout(()=>{ if(m.innerText===msg) m.innerText=''; },t);
}

/* =========================
   Movement & Interaction
   ========================= */
function move(dx,dy) {
  if(gameOver || gameWin || lockAction) return;
  let nx = driverPos.x + dx, ny = driverPos.y + dy;
  if (nx<0 || nx>=COLS || ny<0 || ny>=ROWS) return;
  let cell = gridArr[ny][nx];
  if (cell.isObstacle) return;
  driverPos.x = nx; driverPos.y = ny;
  drawGrid();
  checkCell();
}

// Prevent arrow key scrolling
document.addEventListener('keydown', function(e) {
  if(gameOver || gameWin || lockAction) return;
  
  // Prevent default scrolling behavior for arrow keys
  if(['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
    e.preventDefault();
  }
  
  if(e.key==='ArrowUp') move(0,-1);
  else if(e.key==='ArrowDown') move(0,1);
  else if(e.key==='ArrowLeft') move(-1,0);
  else if(e.key==='ArrowRight') move(1,0);
});

document.querySelector('.ctrl-up').onclick = ()=>move(0,-1);
document.querySelector('.ctrl-down').onclick = ()=>move(0,1);
document.querySelector('.ctrl-left').onclick = ()=>move(-1,0);
document.querySelector('.ctrl-right').onclick = ()=>move(1,0);

// Toggle LLM Panel
document.getElementById('toggleLlmBtn').onclick = toggleLlmPanel;

// Custom Image Instructions
document.getElementById('btnCustomImage').onclick = toggleCustomImageInstructions;

function toggleCustomImageInstructions() {
  const instructions = document.getElementById('customImageInstructions');
  instructions.classList.toggle('show');
}

function getActiveBuilding() { return BUILDINGS[activeBuildingIndex]; }
function getActiveCell() { let pt = getActiveBuilding(); return gridArr[pt.y][pt.x]; }

function checkCell() {
  let cell = gridArr[driverPos.y][driverPos.x];
  if (cell.isAnswer && currAnswerBuildings.length>0 && !lockAction) {
    answerBuildingAction(cell);
    return;
  }
  if (cell.isBirthday) {
    setTimeout(()=>showEnd('game-win'),400);
    return;
  }
  if ((cell.isActive && !cell.isInactive && !cell.isDone && currAnswerBuildings.length==0 && !lockAction)) {
    createAnswerBuildings(cell);
    drawGrid();
    showQuestionBox();
    return;
  }
}

function shuffle(arr) {
  for(let i=arr.length-1;i>0;--i) {
    let j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  } return arr;
}

function randomOtherBuildings_exc(excl=[]) {
  let excludeSet = excl.map(pt=>pt.x+','+pt.y);
  let eligible = [];
  for(let y=0; y<ROWS; y++)
    for(let x=0; x<COLS; x++) {
      let cell = gridArr[y][x];
      if(cell.isObstacle||cell.isInactive||cell.isBirthday||(driverPos.x===x&&driverPos.y===y)) continue;
      if(excludeSet.indexOf(x+','+y)===-1)
        eligible.push(cell);
    }
  return shuffle(eligible);
}

function manhattan(a,b){ return Math.abs(a.x - b.x) + Math.abs(a.y - b.y); }

function findFarthestActiveBuilding(fromIdx){
  const from = BUILDINGS[fromIdx];
  let bestIdx = -1, bestDist = -1;
  for(let i=0;i<BUILDINGS.length;i++){
    if(i===fromIdx) continue;
    const b = BUILDINGS[i];
    const cell = gridArr[b.y][b.x];
    if(cell.isInactive || cell.isDone) continue;
    const d = manhattan(from, b);
    if(d > bestDist){
      bestDist = d;
      bestIdx = i;
    }
  }
  return bestIdx;
}

function reassignOrderFarthest(){
  const currentIdx = activeBuildingIndex;
  const farIdx = findFarthestActiveBuilding(currentIdx);
  if(farIdx !== -1){
    setActiveBuilding(farIdx);
    showMsg(2400, "‚Ü™Ô∏è ƒê∆°n m·ªõi ƒë√£ ƒë∆∞·ª£c g√°n ·ªü v·ªã tr√≠ xa nh·∫•t so v·ªõi ƒë∆°n tr∆∞·ªõc!");
  }
}

function createAnswerBuildings(triggerCell) {
  let pool = questions.filter(q=>q.level>=difficulty&&!q.used);
  currQuestion = (pool.length? pool[0] : questions[Math.floor(Math.random()*questions.length)]);
  if(currQuestion && currQuestion.used !== undefined) currQuestion.used=true;

  let opts = shuffle(currQuestion.options.slice());
  currAnswers = opts;
  currAnswerBuildings = [];
  answerMetaList = [];
  let answerPos = [];
  for(let i=0;i<3;i++) {
    let buildingsAvailable = BUILDINGS
      .filter(b=>!gridArr[b.y][b.x].isInactive&&!gridArr[b.y][b.x].isAnswer && !(b.x === triggerCell.x && b.y === triggerCell.y));
    let extra = randomOtherBuildings_exc(answerPos)[0];
    let tgt;
    if(buildingsAvailable.length>0) tgt = buildingsAvailable.shift();
    else if (extra) tgt = extra;
    else continue;
    let ansCode = ['A','B','C'][i];
    let tgtCell = gridArr[tgt.y][tgt.x];
    tgtCell.isAnswer = true;
    tgtCell.answerText = currAnswers[i];
    tgtCell.isChosen = false;
    tgtCell.answerCode = ansCode;
    answerPos.push({x:tgt.x,y:tgt.y});
    currAnswerBuildings.push({x:tgt.x,y:tgt.y,answer:currAnswers[i],code:ansCode});
    answerMetaList.push({
      code: ansCode,
      answer: currAnswers[i],
      x: tgt.x,
      y: tgt.y
    });
  }
}

function removeAnswerBuildings() {
  currAnswerBuildings.forEach(pt=>{
    let cell = gridArr[pt.y][pt.x];
    cell.isAnswer = false; cell.answerText = null; cell.isChosen = false; cell.answerCode = null;
  });
  currAnswerBuildings = [];
}

function showQuestionBox() {
  let qbox = document.querySelector('.question-box');
  qbox.innerText = (currQuestion?.question || '(Ch∆∞a c√≥ c√¢u h·ªèi)') + "\n(H√£y di chuy·ªÉn ƒë·∫øn 1 to√† nh√† ƒë√°p √°n A/B/C!)";
  let ul = document.querySelector('.answer-list');
  ul.innerHTML = '';
  answerMetaList.forEach(meta=>{
    let type = (gridArr[meta.y][meta.x].isPickup||gridArr[meta.y][meta.x].isDropoff) ? "üè†" : "üè°";
    let li = document.createElement('li');
    li.innerHTML = `
      <span class="answer-tag">${meta.code}</span>
      <span>${meta.answer}</span>
      <span class="answer-coord">${type} (${meta.x},${meta.y})</span>
    `;
    ul.appendChild(li);
  });
  document.querySelector('.msg').innerText = "(H√£y ƒëi·ªÅu khi·ªÉn t√†i x·∫ø ƒë·∫øn ƒë√∫ng v·ªã tr√≠ A/B/C!)";
}

function answerBuildingAction(cell) {
  if(lockAction) return;
  lockAction = true;
  let answer = cell.answerText;
  let isRight = (answer === currQuestion.correct);
  removeAnswerBuildings();
  lastChosenCell = {x:cell.x, y:cell.y};
  if(isRight) {
    score++;
    let acell = getActiveCell();
    acell.isDone = true;
    acell.isActive = false;
    difficulty = Math.min(5, difficulty+1);
    document.querySelector('.msg').innerText = "‚úîÔ∏è ƒê√∫ng! Ti·∫øp t·ª•c giao ƒë∆°n m·ªõi.";
    if((score)>=TOTAL_STOP) {
      let bday = {x: COLS-2, y:1};
      gridArr[bday.y][bday.x].isBirthday = true;
      lockAction = false;
    } else {
      nextActiveBuilding();
    }
  } else {
    if(cell.isPickup||cell.isDropoff) {
      cell.isInactive=true;
      inactiveBuildings.push({x: cell.x, y: cell.y});
    }
    difficulty = Math.max(1,difficulty-1);
    showMsg(1800,"‚ùå Sai! ƒêi·ªÉm n√†y b·ªã v√¥ hi·ªáu h√≥a! ƒê∆°n s·∫Ω ƒë∆∞·ª£c g√°n ·ªü n∆°i xa nh·∫•t.");
    reassignOrderFarthest();
    if(inactiveBuildings.length >= TOTAL_STOP-3) {
      setTimeout(()=>showEnd('game-over'),400);
    }
  }
  updateInfo();
  setTimeout(()=>{
    lastChosenCell=null; lockAction = false; drawGrid();
    if (!gameOver && !gameWin) {
      if(currAnswerBuildings.length===0)
        document.querySelector('.msg').innerText = "üéØ H√£y di chuy·ªÉn ƒë·∫øn ƒëi·ªÉm pickup/dropoff ƒë∆∞·ª£c ƒë√°nh d·∫•u ƒë·ªÉ nh·∫≠n c√¢u h·ªèi ti·∫øp theo!";
    }
  }, 1100);
}

function nextActiveBuilding() {
  for(let add=1;add<=BUILDINGS.length;add++) {
    let ni = (activeBuildingIndex+add) % BUILDINGS.length;
    let b = BUILDINGS[ni];
    let cell = gridArr[b.y][b.x];
    if(!cell.isInactive && !cell.isDone) {
      setActiveBuilding(ni);
      break;
    }
  }
}

function setActiveBuilding(idx) {
  for (const b of BUILDINGS) gridArr[b.y][b.x].isActive = false;
  let b = BUILDINGS[idx];
  activeBuildingIndex = idx;
  gridArr[b.y][b.x].isActive = true;
}

// Enhanced Modal System
function showEnd(type) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  
  const modal = document.createElement('div');
  modal.className = type === 'game-over' ? 'game-over-modal' : 'game-win-modal';
  
  let icon, title, message, stats;
  
  if (type === 'game-over') {
    icon = 'üí•';
    title = 'Game Over!';
    message = 'B·∫°n ƒë√£ h·∫øt to√† nh√† giao nh·∫≠n!';
    stats = `
      <div class="modal-stats">
        üìä <strong>Th·ªëng k√™ cu·ªëi game:</strong><br>
        üèÜ ƒêi·ªÉm s·ªë: ${score}/${TOTAL_STOP}<br>
        üìà ƒê·ªô kh√≥ ƒë·∫°t ƒë∆∞·ª£c: ${difficulty}/5<br>
        üè¢ To√† nh√† c√≤n l·∫°i: ${TOTAL_STOP - inactiveBuildings.length}
      </div>
    `;
    gameOver = true;
  } else {
    icon = 'üéâ';
    title = 'Ch√∫c m·ª´ng!';
    message = 'B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ giao h√†ng v√† nh·∫≠n ƒë∆∞·ª£c b√°nh sinh nh·∫≠t!';
    stats = `
      <div class="modal-stats">
        üèÜ <strong>K·∫øt qu·∫£ xu·∫•t s·∫Øc:</strong><br>
        ‚≠ê ƒêi·ªÉm s·ªë: ${score}/${TOTAL_STOP}<br>
        üöÄ ƒê·ªô kh√≥ cu·ªëi: ${difficulty}/5<br>
        üéØ T·ª∑ l·ªá th√†nh c√¥ng: 100%
      </div>
    `;
    gameWin = true;
  }
  
  modal.innerHTML = `
    <div class="modal-icon">${icon}</div>
    <div class="modal-title">${title}</div>
    <div class="modal-message">${message}</div>
    ${stats}
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-primary" onclick="restartGame()">üîÑ Ch∆°i l·∫°i</button>
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">‚ùå ƒê√≥ng</button>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  document.getElementById('endScene').innerHTML = '';
  
  // Add click outside to close
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal();
  });
}

function closeModal() {
  const overlay = document.querySelector('.modal-overlay');
  if (overlay) {
    overlay.style.animation = 'fadeOut 0.3s ease-out forwards';
    setTimeout(() => {
      overlay.remove();
    }, 300);
  }
}

function restartGame() {
  closeModal();
  setTimeout(gameInit, 100);
}

// Add fadeOut animation
const style = document.createElement('style');
style.textContent = `
  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }
`;
document.head.appendChild(style);

function gameInit() {
  createGridArr();
  score = 0; inactiveBuildings = [];
  activeBuildingIndex = 0;
  driverPos = {x: 0, y: 0};
  difficulty=1;lockAction = false;gameWin=gameOver=false;
  lastChosenCell = null;
  questions.forEach(q=>q.used=false);
  for(let row of gridArr)
    for(let cell of row)
      cell.isDone=false, cell.isInactive=false, cell.isBirthday=false, cell.isAnswer=false, cell.answerText=null, cell.isActive=false, cell.answerCode=null;
  setActiveBuilding(activeBuildingIndex);
  hideQuestion();
  updateInfo();
  updateQuestionSetInfo();
  drawGrid();
  document.getElementById('endScene').innerHTML='';
  showMsg(3000, "üöö Ch√†o m·ª´ng! H√£y di chuy·ªÉn ƒë·∫øn ƒëi·ªÉm pickup/dropoff ƒë∆∞·ª£c ƒë√°nh d·∫•u ƒë·ªÉ b·∫Øt ƒë·∫ßu!");
}

document.getElementById('btnReset').onclick = gameInit;

/* =========================
   LLM Question Generator
   ========================= */
const elApiKey = document.getElementById('apiKey');
const elModel  = document.getElementById('model');
const elKb     = document.getElementById('kb');
const elCount  = document.getElementById('qCount');
const elLang   = document.getElementById('lang');
const elSeed   = document.getElementById('seed');
const elStatus = document.getElementById('llmStatus');

document.getElementById('btnGen').addEventListener('click', handleGenerate);
document.getElementById('btnPreview').addEventListener('click', previewJSON);
document.getElementById('btnImport').addEventListener('click', importJSONDialog);

function previewJSON(){
  const out = JSON.stringify(questions.map(({question,options,correct,level})=>({question,options,correct,level})), null, 2);
  const w = window.open('', '_blank');
  w.document.write(`<pre style="font-family: monospace; padding: 20px; line-height: 1.4;">${escapeHtml(out)}</pre>`);
  w.document.close();
}

function importJSONDialog(){
  const raw = prompt("D√°n JSON c√¢u h·ªèi theo schema ƒë√£ m√¥ t·∫£:");
  if(!raw) return;
  try{
    const data = extractJson(raw);
    const ok = validateQuestionSet(data);
    if(!ok.valid) throw new Error(ok.reason||'B·ªô c√¢u h·ªèi kh√¥ng h·ª£p l·ªá.');
    applyQuestionSet(data, {
      title: "B·ªô c√¢u h·ªèi t√πy ch·ªânh",
      description: "Nh·∫≠p t·ª´ JSON",
      isCustom: true
    });
    elStatus.innerText = `‚úÖ ƒê√£ nh·∫≠p ${data.length} c√¢u h·ªèi. B·ªô c√¢u h·ªèi m·ªõi ƒë√£ √°p d·ª•ng.`;
    elStatus.style.background = '#d4edda';
    elStatus.style.color = '#155724';
  }catch(err){
    elStatus.innerText = `‚ùå L·ªói nh·∫≠p JSON: ${err.message}`;
    elStatus.style.background = '#f8d7da';
    elStatus.style.color = '#721c24';
  }
}

async function handleGenerate(){
  const apiKey = elApiKey.value.trim();
  if(!apiKey){ 
    elStatus.innerText = "‚ö†Ô∏è Nh·∫≠p API Key tr∆∞·ªõc."; 
    elStatus.style.background = '#fff3cd';
    elStatus.style.color = '#856404';
    return; 
  }
  const model  = elModel.value;
  const kb     = elKb.value.trim();
  const count  = Math.max(3, Math.min(30, parseInt(elCount.value||'10',10) || 10));
  const lang   = elLang.value || 'vi';
  const seed   = parseInt(elSeed.value||'42',10) || 42;

  elStatus.innerText = "‚è≥ ƒêang t·∫°o c√¢u h·ªèi t·ª´ LLM...";
  elStatus.style.background = '#cce5ff';
  elStatus.style.color = '#004085';
  
  try{
    const payload = buildChatPayload({model, kb, count, lang, seed});
    const resp = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${apiKey}`
      },
      body: JSON.stringify(payload)
    });
    if(!resp.ok){
      const errText = await resp.text().catch(()=>resp.statusText);
      throw new Error(`OpenAI HTTP ${resp.status}: ${errText}`);
    }
    const data = await resp.json();
    const content = data?.choices?.[0]?.message?.content || '';
    const json = extractJson(content);
    const ok = validateQuestionSet(json);
    if(!ok.valid) throw new Error(ok.reason||'B·ªô c√¢u h·ªèi kh√¥ng h·ª£p l·ªá.');

    const topic = kb ? (kb.substring(0, 30) + (kb.length > 30 ? '...' : '')) : 'T√πy ch·ªânh';
    applyQuestionSet(json, {
      title: "B·ªô c√¢u h·ªèi AI",
      description: `${topic} ‚Ä¢ ${model}`,
      isCustom: true
    });
    elStatus.innerText = `‚úÖ ƒê√£ t·∫°o ${json.length} c√¢u h·ªèi. B·ªô c√¢u h·ªèi m·ªõi ƒë√£ √°p d·ª•ng.`;
    elStatus.style.background = '#d4edda';
    elStatus.style.color = '#155724';
  }catch(err){
    console.error(err);
    elStatus.innerText = `‚ùå Kh√¥ngt·∫°o ƒë∆∞·ª£c c√¢u h·ªèi: ${err.message}`;
    elStatus.style.background = '#f8d7da';
    elStatus.style.color = '#721c24';
  }
}

function buildChatPayload({model, kb, count, lang, seed}){
  const locale = (lang === 'vi') ? "Ti·∫øng Vi·ªát" : "English";
  const sys = `
B·∫°n l√† tr·ª£ l√Ω t·∫°o c√¢u h·ªèi cho game giao h√†ng trong th√†nh ph·ªë 12√ó12.
H√£y xu·∫•t duy nh·∫•t m·ªôt JSON array, KH√îNG gi·∫£i th√≠ch th√™m, theo schema:
[
  {"question": string, "options": [string,string,string], "correct": string, "level": 1..5},
  ...
]
Y√™u c·∫ßu:
- ${count} c√¢u h·ªèi, ng√¥n ng·ªØ: ${locale}.
- Ch·ªß ƒë·ªÅ ph√π h·ª£p ki·∫øn th·ª©c cung c·∫•p (pickup/drop-off, ƒë·ªãa danh, to·∫° ƒë·ªô, quy t·∫Øc ƒë∆∞·ªùng ph·ªë, tuy·∫øn ƒë∆∞·ªùng, v.v.).
- "options" lu√¥n c√≥ 3 ph·∫ßn t·ª≠ r√µ r√†ng, kh√¥ng tr√πng l·∫∑p.
- "correct" l√† 1 trong 3 "options".
- "level" tƒÉng d·∫ßn (x·∫•p x·ªâ ph√¢n b·ªë t·ª´ d·ªÖ‚Üíkh√≥).
- Kh√¥ng d√πng k√Ω t·ª± ƒë·∫∑c bi·ªát l·∫°, kh√¥ng markdown, KH√îNG b·ªçc \`\`\`.
  `.trim();

  const user = `
[KNOWLEDGE BASE]
${kb || '(tr·ªëng)'}
[GOAL]
T·∫°o ${count} c√¢u h·ªèi theo ƒë√∫ng schema ·ªü tr√™n.
  `.trim();

  const messages = [
    {role:"system", content: sys},
    {role:"user", content: user}
  ];

  const payload = {
    model,
    messages,
    temperature: 0.4,
    top_p: 0.9,
    n: 1
  };
  payload.seed = seed;
  return payload;
}

function extractJson(text){
  try{ return JSON.parse(text); }catch(_){}
  const fence = text.match(/```json([\s\S]*?)```/i);
  if(fence){
    const inner = fence[1].trim();
    return JSON.parse(inner);
  }
  const start = text.indexOf('['), end = text.lastIndexOf(']');
  if(start !== -1 && end !== -1 && end > start){
    const slice = text.slice(start, end+1);
    return JSON.parse(slice);
  }
  throw new Error("Kh√¥ng t√¨m th·∫•y JSON h·ª£p l·ªá trong ph·∫£n h·ªìi.");
}

function validateQuestionSet(arr){
  if(!Array.isArray(arr) || arr.length===0)
    return {valid:false, reason:"Ph·∫£n h·ªìi kh√¥ng ph·∫£i m·∫£ng JSON ho·∫∑c r·ªóng."};
  for(let i=0;i<arr.length;i++){
    const it = arr[i];
    if(!it || typeof it!=='object') return {valid:false, reason:`Ph·∫ßn t·ª≠ ${i} kh√¥ng h·ª£p l·ªá.`};
    const {question, options, correct, level} = it;
    if(typeof question!=='string' || !question.trim()) return {valid:false, reason:`C√¢u ${i+1}: 'question' thi·∫øu ho·∫∑c r·ªóng.`};
    if(!Array.isArray(options) || options.length!==3) return {valid:false, reason:`C√¢u ${i+1}: 'options' ph·∫£i c√≥ ƒë√∫ng 3 ph·∫ßn t·ª≠.`};
    if(options.some(o=>typeof o!=='string' || !o.trim())) return {valid:false, reason:`C√¢u ${i+1}: C√≥ ƒë√°p √°n r·ªóng.`};
    if(typeof correct!=='string' || !options.includes(correct)) return {valid:false, reason:`C√¢u ${i+1}: 'correct' kh√¥ng n·∫±m trong 'options'.`};
    if(typeof level!=='number' || level<1 || level>5) return {valid:false, reason:`C√¢u ${i+1}: 'level' ph·∫£i trong [1..5].`};
  }
  return {valid:true};
}

function applyQuestionSet(newSet, info = null){
  questions = newSet.map(q=>({
    question: String(q.question),
    options: [String(q.options[0]), String(q.options[1]), String(q.options[2])],
    correct: String(q.correct),
    level: Math.max(1, Math.min(5, parseInt(q.level,10)||1)),
    used: false
  }));
  questions.forEach(q=>q.used=false);
  
  // Update question set info
  if (info) {
    currentQuestionSetInfo = info;
  }
  
  // Update UI
  updateQuestionSetInfo();
  
  showMsg(2500, "üìö B·ªô c√¢u h·ªèi m·ªõi ƒë√£ s·∫µn s√†ng. Ti·∫øp t·ª•c ch∆°i ƒë·ªÉ th·∫•y c√¢u h·ªèi m·ªõi.");
}

function escapeHtml(s){
  return s.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
}

// Initialize game on load
document.addEventListener('DOMContentLoaded', function() {
  // Set initial question set info
  updateQuestionSetInfo();
  
  // Initialize game
gameInit();
  
  // Add some helpful tooltips
  const tooltips = {
    'btnReset': 'Kh·ªüi ƒë·ªông l·∫°i game v·ªõi b·ªô c√¢u h·ªèi hi·ªán t·∫°i',
    'toggleLlmBtn': 'M·ªü/ƒë√≥ng panel t·∫°o c√¢u h·ªèi m·ªõi b·∫±ng AI',
    'btnGen': 'S·ª≠ d·ª•ng OpenAI ƒë·ªÉ t·∫°o b·ªô c√¢u h·ªèi m·ªõi d·ª±a tr√™n ki·∫øn th·ª©c ƒë√£ nh·∫≠p',
    'btnPreview': 'Xem to√†n b·ªô c√¢u h·ªèi hi·ªán t·∫°i d∆∞·ªõi d·∫°ng JSON',
    'btnImport': 'Nh·∫≠p b·ªô c√¢u h·ªèi t·ª´ JSON c√≥ s·∫µn'
  };
  
  Object.entries(tooltips).forEach(([id, tooltip]) => {
    const element = document.getElementById(id);
    if (element && !element.hasAttribute('title')) {
      element.setAttribute('title', tooltip);
    }
  });
  
  // Add keyboard shortcuts info
  document.addEventListener('keydown', function(e) {
    // Toggle LLM panel with Ctrl+Q
    if (e.ctrlKey && e.key === 'q') {
      e.preventDefault();
      toggleLlmPanel();
    }
    
    // Reset game with Ctrl+R (prevent default browser refresh)
    if (e.ctrlKey && e.key === 'r') {
      e.preventDefault();
      gameInit();
    }
  });
});

// Add some game statistics tracking
let gameStats = {
  gamesPlayed: 0,
  totalScore: 0,
  bestScore: 0,
  questionsAnswered: 0,
  correctAnswers: 0,
  customQuestionSetsUsed: 0
};

// Load stats from localStorage
try {
  const saved = localStorage.getItem('deliveryGameStats');
  if (saved) {
    gameStats = {...gameStats, ...JSON.parse(saved)};
  }
} catch (e) {
  console.warn('Could not load game stats from localStorage');
}

// Save stats to localStorage
function saveGameStats() {
  try {
    localStorage.setItem('deliveryGameStats', JSON.stringify(gameStats));
  } catch (e) {
    console.warn('Could not save game stats to localStorage');
  }
}

// Update game statistics
function updateGameStats(gameEnded = false, wasCorrectAnswer = null) {
  if (gameEnded) {
    gameStats.gamesPlayed++;
    gameStats.totalScore += score;
    if (score > gameStats.bestScore) {
      gameStats.bestScore = score;
    }
    if (currentQuestionSetInfo.isCustom) {
      gameStats.customQuestionSetsUsed++;
    }
  }
  
  if (wasCorrectAnswer !== null) {
    gameStats.questionsAnswered++;
    if (wasCorrectAnswer) {
      gameStats.correctAnswers++;
    }
  }
  
  saveGameStats();
}

// Enhanced modal with stats
function showEnd(type) {
  updateGameStats(true);
  
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  
  const modal = document.createElement('div');
  modal.className = type === 'game-over' ? 'game-over-modal' : 'game-win-modal';
  
  let icon, title, message, stats;
  
  const accuracy = gameStats.questionsAnswered > 0 ? 
    Math.round((gameStats.correctAnswers / gameStats.questionsAnswered) * 100) : 0;
  const avgScore = gameStats.gamesPlayed > 0 ? 
    Math.round((gameStats.totalScore / gameStats.gamesPlayed) * 10) / 10 : 0;
  
  if (type === 'game-over') {
    icon = 'üí•';
    title = 'Game Over!';
    message = 'B·∫°n ƒë√£ h·∫øt to√† nh√† giao nh·∫≠n!';
    stats = `
      <div class="modal-stats">
        üìä <strong>Th·ªëng k√™ game n√†y:</strong><br>
        üèÜ ƒêi·ªÉm s·ªë: ${score}/${TOTAL_STOP}<br>
        üìà ƒê·ªô kh√≥ ƒë·∫°t ƒë∆∞·ª£c: ${difficulty}/5<br>
        üè¢ To√† nh√† c√≤n l·∫°i: ${TOTAL_STOP - inactiveBuildings.length}<br><br>
        üìà <strong>Th·ªëng k√™ t·ªïng th·ªÉ:</strong><br>
        üéÆ S·ªë game ƒë√£ ch∆°i: ${gameStats.gamesPlayed}<br>
        üèÖ ƒêi·ªÉm cao nh·∫•t: ${gameStats.bestScore}<br>
        üìä ƒêi·ªÉm trung b√¨nh: ${avgScore}<br>
        üéØ ƒê·ªô ch√≠nh x√°c: ${accuracy}%
      </div>
    `;
    gameOver = true;
  } else {
    icon = 'üéâ';
    title = 'Ch√∫c m·ª´ng!';
    message = 'B·∫°n ƒë√£ ho√†n th√†nh t·∫•t c·∫£ giao h√†ng v√† nh·∫≠n ƒë∆∞·ª£c b√°nh sinh nh·∫≠t!';
    stats = `
      <div class="modal-stats">
        üèÜ <strong>K·∫øt qu·∫£ xu·∫•t s·∫Øc:</strong><br>
        ‚≠ê ƒêi·ªÉm s·ªë: ${score}/${TOTAL_STOP}<br>
        üöÄ ƒê·ªô kh√≥ cu·ªëi: ${difficulty}/5<br>
        üéØ T·ª∑ l·ªá th√†nh c√¥ng: 100%<br><br>
        üìà <strong>Th·ªëng k√™ t·ªïng th·ªÉ:</strong><br>
        üéÆ S·ªë game ƒë√£ ch∆°i: ${gameStats.gamesPlayed}<br>
        üèÖ ƒêi·ªÉm cao nh·∫•t: ${gameStats.bestScore}<br>
        üìä ƒêi·ªÉm trung b√¨nh: ${avgScore}<br>
        üéØ ƒê·ªô ch√≠nh x√°c: ${accuracy}%
      </div>
    `;
    gameWin = true;
  }
  
  modal.innerHTML = `
    <div class="modal-icon">${icon}</div>
    <div class="modal-title">${title}</div>
    <div class="modal-message">${message}</div>
    ${stats}
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-primary" onclick="restartGame()">üîÑ Ch∆°i l·∫°i</button>
      <button class="modal-btn modal-btn-secondary" onclick="closeModal()">‚ùå ƒê√≥ng</button>
    </div>
  `;
  
  overlay.appendChild(modal);
  document.body.appendChild(overlay);
  document.getElementById('endScene').innerHTML = '';
  
  // Add click outside to close
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) closeModal();
  });
}

// Update answerBuildingAction to track stats
function answerBuildingAction(cell) {
  if(lockAction) return;
  lockAction = true;
  let answer = cell.answerText;
  let isRight = (answer === currQuestion.correct);
  removeAnswerBuildings();
  lastChosenCell = {x:cell.x, y:cell.y};
  
  // Update statistics
  updateGameStats(false, isRight);
  
  if(isRight) {
    score++;
    let acell = getActiveCell();
    acell.isDone = true;
    acell.isActive = false;
    difficulty = Math.min(5, difficulty+1);
    document.querySelector('.msg').innerText = "‚úîÔ∏è ƒê√∫ng! Ti·∫øp t·ª•c giao ƒë∆°n m·ªõi.";
    if((score)>=TOTAL_STOP) {
      let bday = {x: COLS-2, y:1};
      gridArr[bday.y][bday.x].isBirthday = true;
      lockAction = false;
    } else {
      nextActiveBuilding();
    }
  } else {
    if(cell.isPickup||cell.isDropoff) {
      cell.isInactive=true;
      inactiveBuildings.push({x: cell.x, y: cell.y});
    }
    difficulty = Math.max(1,difficulty-1);
    showMsg(1800,"‚ùå Sai! ƒêi·ªÉm n√†y b·ªã v√¥ hi·ªáu h√≥a! ƒê∆°n s·∫Ω ƒë∆∞·ª£c g√°n ·ªü n∆°i xa nh·∫•t.");
    reassignOrderFarthest();
    if(inactiveBuildings.length >= TOTAL_STOP-3) {
      setTimeout(()=>showEnd('game-over'),400);
    }
  }
  updateInfo();
  setTimeout(()=>{
    lastChosenCell=null; lockAction = false; drawGrid();
    if (!gameOver && !gameWin) {
      if(currAnswerBuildings.length===0)
        document.querySelector('.msg').innerText = "üéØ H√£y di chuy·ªÉn ƒë·∫øn ƒëi·ªÉm pickup/dropoff ƒë∆∞·ª£c ƒë√°nh d·∫•u ƒë·ªÉ nh·∫≠n c√¢u h·ªèi ti·∫øp theo!";
    }
  }, 1100);
}

// Add console info for developers
console.log(`
üöö Game T√†i X·∫ø Giao H√†ng ƒë√£ ƒë∆∞·ª£c t·∫£i!

‚å®Ô∏è Ph√≠m t·∫Øt:
‚Ä¢ M≈©i t√™n: Di chuy·ªÉn
‚Ä¢ Ctrl+Q: M·ªü/ƒë√≥ng panel AI
‚Ä¢ Ctrl+R: Kh·ªüi ƒë·ªông l·∫°i game

üéÆ H∆∞·ªõng d·∫´n ch∆°i:
1. Di chuy·ªÉn ƒë·∫øn ƒëi·ªÉm pickup/dropoff c√≥ ƒë√°nh d·∫•u
2. Tr·∫£ l·ªùi c√¢u h·ªèi b·∫±ng c√°ch di chuy·ªÉn ƒë·∫øn ƒë√°p √°n A/B/C
3. Ho√†n th√†nh ${TOTAL_STOP} ƒë∆°n h√†ng ƒë·ªÉ th·∫Øng game

üìä Th·ªëng k√™ ƒë∆∞·ª£c l∆∞u trong localStorage
ü§ñ C√≥ th·ªÉ t·∫°o c√¢u h·ªèi m·ªõi b·∫±ng OpenAI API
`);
</script>
</body>
</html>
