<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Game đua xe 5 làn, bắn điểm + smooth</title>
  <style>
    body {
      background: #222;
      color: #fff;
      text-align: center;
      font-family: Arial, sans-serif;
    }
    h1 { margin-top: 20px; }
    #gameContainer {
      margin: 40px auto;
      width: 400px;
    }
    canvas {
      background: #444;
      display: block;
      margin: 0 auto;
      border-radius: 8px;
      box-shadow: 0 0 12px #000d;
    }
    #restartBtn {
      margin-top: 20px;
      display: none;
      padding: 10px 25px;
      font-size: 1.2rem;
      background: #33c;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #score, #invisibleStatus, #playerHpBar {
      font-size: 1.2rem;
      margin-top: 15px;
    }
    #playerHpBar {
      margin-top: 5px;
    }
    #invisibleStatus { color: #3ff177; }
    #cooldownStatus {
      font-size: 1.1rem;
      color: #e3e82e;
    }
    .hint {
      color: #ccc;
      margin: 10px 0 0 0;
      font-size: 0.97rem;
    }
  </style>
</head>
<body>
  <h1>Game Đua Xe 5 Làn - Bắn Điểm + Smooth</h1>
  <div class="hint">
    - <b>Trái/Phải</b>: chọn làn (5 làn, di chuyển mượt)<br>
    - <b>F</b> / <b>Space</b>: bắn đạn, bắn nổ xe địch +1 điểm, xe vượt quá -1 điểm<br>
    - <b>R</b>: ẩn xe 1.5s (chờ 5s để dùng lại)<br>
    - Xe bạn <b>5HP</b>, địch <b>2HP</b>
  </div>
  <div id="gameContainer">
    <canvas id="racingGame" width="400" height="600"></canvas>
    <div id="score">Điểm: 0</div>
    <div id="playerHpBar"></div>
    <div id="invisibleStatus"></div>
    <div id="cooldownStatus"></div>
    <button id="restartBtn">Chơi lại</button>
  </div>
  <script>
    // ---- PARAMETERS ----
    const CAR_WIDTH = 44, CAR_HEIGHT = 82;
    const PLAYER_INIT_HP = 5;
    const PLAYER_START_LANE = 2; // Giữa
    const OBSTACLE_HP = 2;
    const NUM_LANES = 5;
    const LANE_OFFSET_Y = 20;
    const ROAD_X1 = 76, ROAD_X2 = 324; // 400px canvas, đường rộng 248px
    const LANE_SPACING = (ROAD_X2 - ROAD_X1 - CAR_WIDTH) / (NUM_LANES-1); // spacing center to center

    // --- GAME VARS ---
    let player = {
      lane: PLAYER_START_LANE,
      targetLane: PLAYER_START_LANE,
      x: laneToX(PLAYER_START_LANE),
      y: 485,
      width: CAR_WIDTH,
      height: CAR_HEIGHT,
      hp: PLAYER_INIT_HP,
      maxHp: PLAYER_INIT_HP,
      moveSpeed: 7
    };
    let obstacles = [];
    let bullets = [];
    let score = 0;
    let gameOver = false;
    let animationId;

    // INVISIBLE
    let invisible = false;
    let invisibleStartTime = 0;
    const INVISIBLE_DURATION = 1500;
    let cooldown = false;
    let cooldownStart = 0;
    const COOLDOWN_TIME = 5000;

    // PHÍM
    let leftPressed = false, rightPressed = false;

    // -------- UTILS --------
    function laneToX(lane) {
      return ROAD_X1 + lane * LANE_SPACING;
    }
    // Giá trị nguyên trong [0,NUM_LANES-1]
    function adjustLane(delta) {
      player.targetLane = Math.max(0, Math.min(NUM_LANES-1, player.targetLane + delta));
    }
    function drawRoad() {
      ctx.fillStyle = "#666";
      ctx.fillRect(ROAD_X1-16, 0, ROAD_X2-ROAD_X1+32, 600);
      // Làn kẻ
      ctx.setLineDash([14, 15]);
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 3;
      for (let i=1;i<NUM_LANES;i++) {
        let x = ROAD_X1 + i*LANE_SPACING + CAR_WIDTH/2;
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, 600);
        ctx.stroke();
      }
      ctx.setLineDash([]);
    }
    function drawCar(car, color, options={}) {
      // options: {invisible, blink, hitFlash, hpBar}
      if (options.invisible && options.blink) {
        if (Math.floor(Date.now()/80) % 2 === 0) return;
      }
      ctx.save();
      if (options.invisible) {
        ctx.globalAlpha = 0.5;
        color = "#5cf";
      }
      if (options.hitFlash) {
        ctx.globalAlpha = 0.82;
        color = "#fff12e";
      }
      ctx.fillStyle = color;
      ctx.fillRect(car.x, car.y, car.width, car.height);
      // Kính lái
      ctx.fillStyle = "#aad";
      ctx.fillRect(car.x+9, car.y+14, car.width-18, 18);
      // Bánh xe
      ctx.fillStyle = "#222";
      ctx.fillRect(car.x-6, car.y+8, 9, 18);
      ctx.fillRect(car.x+car.width-3, car.y+8, 9, 18);
      ctx.fillRect(car.x-6, car.y+car.height-28, 9, 18);
      ctx.fillRect(car.x+car.width-3, car.y+car.height-28, 9, 18);
      // Thanh HP
      if (options.hpBar) {
        let barW = car.width-12, barH = 6, barX = car.x+6, barY=car.y+car.height-10;
        ctx.strokeStyle = "#111";
        ctx.strokeRect(barX, barY, barW, barH);
        ctx.fillStyle = "#0f0";
        let percent = Math.max(0, car.hp/car.maxHp);
        ctx.fillRect(barX, barY, barW*percent, barH);
      }
      ctx.restore();
    }
    function drawObstacles() {
      for (const obs of obstacles) {
        let flash = obs.hitFlash && (Date.now() - obs.hitFlash < 200);
        drawCar(obs, "#0d8", {hpBar:true, hitFlash:flash});
      }
    }
    function drawBullets() {
      ctx.save();
      for (const b of bullets) {
        ctx.globalAlpha = 0.88;
        ctx.fillStyle = "#ffe145";
        ctx.fillRect(b.x, b.y, b.width, b.height);
        ctx.fillStyle = "#c9ab14";
        ctx.fillRect(b.x+1, b.y, b.width-2, b.height);
      }
      ctx.restore();
    }
    function detectCollision(r1, r2) {
      return (r1.x < r2.x + r2.width &&
              r1.x + r1.width > r2.x &&
              r1.y < r2.y + r2.height &&
              r1.y + r1.height > r2.y);
    }
    function updatePlayerHpBar() {
      const bar = document.getElementById('playerHpBar');
      let per = player.hp / player.maxHp;
      let color = per > 0.6 ? "#0f0" : per > 0.3 ? "#ff0" : "#f30";
      let bars = "";
      for (let i=1;i<=player.maxHp;i++) bars += `<span style="color:${i<=player.hp?color:'#444'};font-weight:bold;font-size:1.1em;">♥</span> `;
      bar.innerHTML = "HP: " + bars;
    }
    function updateCooldownStatus() {
      const stDiv = document.getElementById('cooldownStatus');
      if (cooldown) {
        const left = Math.max(0, COOLDOWN_TIME - (Date.now() - cooldownStart));
        stDiv.textContent = "Chờ sử dụng R: " + (left/1000).toFixed(1) + "s";
      } else {
        stDiv.textContent = "";
      }
    }

    // -------- GAME LOGIC --------
    function resetGame() {
      player.lane = player.targetLane = PLAYER_START_LANE;
      player.x = laneToX(player.lane);
      player.hp = player.maxHp = PLAYER_INIT_HP;
      obstacles = [];
      bullets = [];
      score = 0;
      gameOver = false;
      invisible = false;
      cooldown = false;
      document.getElementById('score').textContent = `Điểm: 0`;
      document.getElementById('invisibleStatus').textContent = "";
      document.getElementById('restartBtn').style.display = "none";
      document.getElementById('cooldownStatus').textContent = "";
      updatePlayerHpBar();
      animate();
    }
    function newObstacle() {
      // Random 1 trong 5 làn
      const l = Math.floor(Math.random()*NUM_LANES);
      const x = laneToX(l);
      const w = CAR_WIDTH, h = CAR_HEIGHT;
      const speed = 3 + Math.random()*2 + Math.abs(score)/30;
      return {lane:l, x:x, y:-h, width:w, height:h, speed:speed, hp:OBSTACLE_HP, maxHp:OBSTACLE_HP, hitFlash:0};
    }
    function updateObstacles() {
      for (const obs of obstacles) obs.y += obs.speed;
      // Sinh thêm xe?
      if (obstacles.length < 5 || (obstacles.length>0 && obstacles[obstacles.length-1].y > 145)) {
        obstacles.push(newObstacle());
      }
      // Xóa xe ra khỏi màn hình & trừ điểm nếu không bị bắn
      if (obstacles.length && obstacles[0].y > canvas.height) {
        if (obstacles[0].hp > 0) {
          score -= 1;
          updateScore();
        }
        obstacles.shift();
      }
    }
    function playerShoot() {
      let bulletW = 10, bulletH = 24;
      let b = {
        x: laneToX(player.targetLane) + CAR_WIDTH/2 - bulletW/2,
        y: player.y - bulletH + 5,
        width: bulletW,
        height: bulletH,
        speed: 12,
        lane: player.targetLane
      };
      bullets.push(b);
    }
    function updateBullets() {
      for (let i = bullets.length - 1; i >= 0; i--) {
        const b = bullets[i];
        b.y -= b.speed;
        // Nếu ngoài màn hình thì loại bỏ
        if (b.y + b.height < 0) {
          bullets.splice(i,1);
          continue;
        }
        // Kiểm tra trúng xe địch cùng làn
        for (let j = 0; j < obstacles.length; j++) {
          let obs = obstacles[j];
          if (obs.hp > 0 && b.lane === obs.lane && detectCollision(b, obs)) {
            obs.hp -= 1;
            obs.hitFlash = Date.now();
            if (obs.hp <= 0) {
              score += 1;
              updateScore();
              setTimeout(()=>{ if (obstacles[j] === obs) obstacles.splice(j,1); }, 150);
            }
            bullets.splice(i,1);
            break;
          }
        }
      }
    }
    function updateScore() {
      document.getElementById('score').textContent = `Điểm: ${score}`;
    }
    function animate() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      drawRoad();

      // Smooth: player x tiến tới làn mong muốn
      let destX = laneToX(player.targetLane);
      // Giảm tốc độ ở gần đích
      let dx = destX - player.x;
      if (Math.abs(dx) > 1) {
        player.x += dx * 0.23; // "làm mượt": mỗi frame chạy ~23% quãng đường còn lại
      } else {
        player.x = destX;
      }

      // Xe tôi
      let blink = (invisible && ((Date.now() - invisibleStartTime) < INVISIBLE_DURATION));
      drawCar(player, "#e33", {invisible, blink});
      updatePlayerHpBar();
      drawObstacles();
      drawBullets();
      updateObstacles();
      updateBullets();

      // INVISIBLE
      if (invisible && (Date.now() - invisibleStartTime) > INVISIBLE_DURATION) {
        invisible = false;
        document.getElementById('invisibleStatus').textContent = "";
      }
      if (invisible && !gameOver) {
        document.getElementById('invisibleStatus').textContent = "Tàng hình! (+1.5 giây)";
      } else {
        document.getElementById('invisibleStatus').textContent = "";
      }
      // Va chạm với địch (chỉ nếu còn hp)
      if (!invisible && !gameOver) {
        for (const obs of obstacles) {
          if (obs.hp > 0 && detectCollision(player, obs)) {
            player.hp -= 1;
            updatePlayerHpBar();
            if (player.hp <= 0) {
              gameOver = true;
              cancelAnimationFrame(animationId);
              document.getElementById('restartBtn').style.display = "block";
              ctx.font = "bold 48px Arial";
              ctx.fillStyle = "#fff";
              ctx.fillText("THUA!", 140, 310);
              return;
            } else {
              obs.y += 100;
            }
          }
        }
      }
      // Cooldown R
      if (cooldown) {
        if (Date.now() - cooldownStart >= COOLDOWN_TIME) {
          cooldown = false;
          document.getElementById('cooldownStatus').textContent = "";
        }
      }
      updateCooldownStatus();
      if (!gameOver) {
        animationId = requestAnimationFrame(animate);
      }
    }

    // -------- EVENTS ------------
    document.addEventListener('keydown', e => {
      if (e.key === "ArrowLeft" || e.key === "a") {
        if (!leftPressed) {
          adjustLane(-1);
          leftPressed = true;
        }
      }
      if (e.key === "ArrowRight" || e.key === "d") {
        if (!rightPressed) {
          adjustLane(1);
          rightPressed = true;
        }
      }
      if ((e.key === "R" || e.key === "r") && !invisible && !cooldown && !gameOver) {
        invisible = true;
        invisibleStartTime = Date.now();
        cooldown = true;
        cooldownStart = Date.now();
        updateCooldownStatus();
      }
      if ((e.key === "f" || e.key === "F" || e.key === " " ) && !gameOver) {
        playerShoot();
      }
    });
    document.addEventListener('keyup', e => {
      if (e.key === "ArrowLeft" || e.key === "a") leftPressed = false;
      if (e.key === "ArrowRight" || e.key === "d") rightPressed = false;
    });
    document.getElementById('restartBtn').onclick = resetGame;

    // ------- INIT -------
    const canvasElem = document.getElementById('racingGame');
    const ctx = canvasElem.getContext('2d');
    resetGame();

  </script>
</body>
</html>
